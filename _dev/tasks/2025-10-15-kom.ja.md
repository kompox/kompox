---
id: 2025-10-15-kom
title: KOM(Kompox Ops Manifest) 導入と適用
status: draft
updated: 2025-10-15
language: ja
owner: yaegashi
---
# Task: KOM(Kompox Ops Manifest) 導入と適用

## 目的

- [K4x-ADR-009] ("Kompox Ops Manifest Schema") で決定した `ops.kompox.dev/id` による Resource ID を全コンポーネントへ適用する。
- 旧 `ops.kompox.dev/path` と非型付き FQN の使用を廃止し、KOM スキーマの ID を一次キーとして統一する。
- 将来の Kind 追加(例: ing) と v2 Operator への橋渡しを容易にする。

## スコープ / 非スコープ

- In:
  - [Kompox-CRD.ja.md] の KOM 反映と用語統一
  - CLI ローダー/バリデータの `ops.kompox.dev/id` 対応(厳格検証)
  - ストア(inmem/RDB)の主キーを Resource ID に統一
- Out:
  - v2 Operator の実装(監視・調停)そのもの
  - 追加 Kind(ing 等)の仕様詳細(別タスク)
  - 後方互換性・移行ガイド（不要）

## 仕様サマリ

- 用語: KOM(Kompox Ops Manifest), Resource ID(alias: FQN), Kind shortnames(ws|prv|cls|app|box|…)
- ID 形式: `/ <kind> / <name> ( / <kind> / <name> )*`、先頭 `/` 必須、name は DNS-1123 label
- すべての Kind(Workspace 含む)で `metadata.annotations["ops.kompox.dev/id"]` を必須
- ハッシュは Resource ID から算出し、K8s ラベル値には短縮ハッシュを使用
- 参考: [K4x-ADR-009], [Kompox-CRD.ja.md]

## 計画 (チェックリスト)

- [x] 前提合意と準備
  - [x] [K4x-ADR-009] の最終化: status を accepted へ(合意後)
  - [x] 用語・記法の最終確認 (Resource ID/FQN/Kind shortnames)
- [x] ドキュメントとスキーマ整備
  - [x] [Kompox-CRD.ja.md] を KOM に全面更新 (フィールド仕様・例・用語統一)
  - [x] FQN を Resource ID の別名として明記
- [x] CLI ローダー/バリデータ実装
  - [x] Resource ID パーサ実装 `/kind/name(…)*`
  - [x] 厳格バリデーション: kind/name/DNS-1123/親チェーン
  - [x] `ops.kompox.dev/id` を必須化し、欠落時は明確なエラーにする
  - [x] 単体テスト: 正常/異常系の追加
- [x] テストフィクスチャ更新
  - [x] `tests/aks-e2e-crd/crd.in/*.yml` を `ops.kompox.dev/id` に更新
- [x] CLI ドキュメント更新
  - [x] `design/v1/Kompox-CLI.ja.md`: 用語を Resource ID に統一
  - [x] `design/v1/Kompox-CLI.ja.md`: 例示を変数形式に更新
- [x] ドキュメント索引再生成
  - [x] `make gen-index`
- [x] 検証
  - [x] `make build` が PASS
  - [x] `make test` が PASS

## テスト

- ユニット:
  - ID パーサ/バリデータ: 正常系/異常系(kind 不一致、先頭スラ無し、DNS-1123 違反、親チェーン不整合)
- E2E:
  - `tests/aks-e2e-crd/` が KOM スキーマで成功（今後のテスト）

## 受け入れ条件

- `make build`/`make test` が PASS
- 主要ドキュメント([K4x-ADR-009]/CRD spec)が KOM と Resource ID に整合

## メモ

- リスク: ドキュメント更新漏れによる混乱
- フォローアップ: 追加 Kind(ing)の ID ルール定義、Operator 側のウォッチ/ラベル整備

## 進捗

- 2025-10-15: タスク作成
- 2025-10-15: Phase 1 完了 - CRD パッケージの KOM 実装
  - `config/crd/ops/v1alpha1` パッケージを完全に新 Resource ID 形式に移行
  - 実装内容:
    - `types.go`: `AnnotationID` 定数の追加（`ops.kompox.dev/id`）
    - `fqn.go`: Resource ID パーサ/バリデータの完全実装
      - `ParseResourceID()`: 型付きパス形式のパース
      - `ValidateResourceID()`: 厳格な検証（kind/name/親チェーン）
      - `BuildResourceID()`: Resource ID の構築
      - `ExtractResourceID()`: アノテーションからの抽出
    - `loader.go`: `ExtractResourceID()` を使用するように更新
    - `sink.go`, `sink_tomodels.go`: Resource ID をキーとして使用
    - `validator.go`: Resource ID 検証ロジックの更新
    - `cmd/kompoxops/crd_loader.go`: CLI ローダーの更新
  - テスト更新:
    - `fqn_test.go`: 新形式の完全テストスイート
    - `loader_test.go`: YAML フィクスチャを `ops.kompox.dev/id` に更新
    - `sink_test.go`: Resource ID 形式でのテスト
    - `sink_tomodels_test.go`: すべてのテストケースを新形式に移行
    - `validator_test.go`: FQN 期待値を Resource ID 形式に更新
    - `cmd/kompoxops/crd_integration_test.go`: 統合テストのYAMLフィクスチャを新形式に更新
      - "load valid CRD file" テストケース: 4リソースのアノテーションを `ops.kompox.dev/id` に変更
      - "infer default app name from single app" テストケース: 同様に新形式に変更
  - E2Eテストフィクスチャ更新:
    - `tests/aks-e2e-crd/crd.in/workspace.yml`: `ops.kompox.dev/id: /ws/${SERVICE_NAME}` に変更
    - `tests/aks-e2e-crd/crd.in/provider.yml`: `ops.kompox.dev/id: /ws/${SERVICE_NAME}/prv/aks1` に変更
    - `tests/aks-e2e-crd/crd.in/cluster.yml`: `ops.kompox.dev/id: /ws/${SERVICE_NAME}/prv/aks1/cls/cluster1` に変更
    - `tests/aks-e2e-crd/kompoxapp.yml.in`: `ops.kompox.dev/id: /ws/${SERVICE_NAME}/prv/aks1/cls/cluster1/app/basic` に変更
  - 検証結果:
    - ✅ `go test ./config/crd/ops/v1alpha1/...` 全テスト合格
    - ✅ `make build` 成功
    - ✅ `make test` 成功
  - Resource ID 形式の例（変数表記）:
    - Workspace: `/ws/<ws>`
    - Provider: `/ws/<ws>/prv/<prv>`
    - Cluster: `/ws/<ws>/prv/<prv>/cls/<cls>`
    - App: `/ws/<ws>/prv/<prv>/cls/<cls>/app/<app>`
    - Box: `/ws/<ws>/prv/<prv>/cls/<cls>/app/<app>/box/<box>`
- 2025-10-15: CLI ドキュメント更新 - `design/v1/Kompox-CLI.ja.md`
  - すべての FQN (Fully Qualified Name) 用語を Resource ID に置き換え
  - Resource ID 例を具体値から変数形式に統一:
    - 変更前: `/ws/ws1/prv/prv1/cls/cls1/app/app1`
    - 変更後: `/ws/<ws>/prv/<prv>/cls/<cls>/app/<app>`
  - 影響範囲:
    - CRD モード説明セクション
    - `cluster` コマンドの `--cluster-id` オプション
    - `app`, `secret pull`, `dns`, `disk`, `snapshot`, `box` コマンドの `--app-id` オプション
    - 設計判断セクション（"Resource ID ベース ID システム"）
  - 一貫性向上: すべての Resource ID 参照が変数プレースホルダー形式に統一され、ドキュメントの教育的価値が向上
- 2025-10-15: CRD ドキュメント更新 - `design/v1/Kompox-CRD.ja.md`
  - すべての FQN (Fully Qualified Name) 用語を Resource ID に統一
  - FQN を Resource ID の別名として明記
  - 影響範囲:
    - 概要セクション: Resource ID の定義と用語統一
    - Kompox Ops Manifest Schema: `ops.kompox.dev/id` の説明更新、FQN を別名として明記
    - Non-K8s リソース ID・永続化ストア: Resource ID の定義を明確化
    - ローダー仕様: 用語統一
    - 命名制約: "FQN 文字列" → "Resource ID 文字列"
    - CLI のリソース指定: すべての FQN 参照を Resource ID に変更、例示更新
  - 検証結果:
    - ✅ FQN が Resource ID の別名として正しく文書化
    - ✅ `make gen-index` 成功
- 2025-10-15: ドキュメント索引再生成
  - `make gen-index` を実行し、すべての索引ファイルを最新化

## 参考

- [K4x-ADR-009]
- [Kompox-CRD.ja.md]
- [tests/aks-e2e-crd/]

[K4x-ADR-009]: ../../design/adr/K4x-ADR-009.md
[Kompox-CRD.ja.md]: ../../design/v1/Kompox-CRD.ja.md
[tests/aks-e2e-crd/]: ../../tests/aks-e2e-crd/
