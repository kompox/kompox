---
id: 2025-10-15-kom
title: KOM(Kompox Ops Manifest) 導入と適用
status: draft
updated: 2025-10-15
language: ja
owner: yaegashi
---
# Task: KOM(Kompox Ops Manifest) 導入と適用

## 目的

- [K4x-ADR-009] ("Kompox Ops Manifest Schema") で決定した `ops.kompox.dev/id` による Resource ID を全コンポーネントへ適用する。
- 旧 `ops.kompox.dev/path` と非型付き FQN の使用を廃止し、KOM スキーマの ID を一次キーとして統一する。
- 将来の Kind 追加(例: ing) と v2 Operator への橋渡しを容易にする。

## スコープ / 非スコープ

- In:
  - [Kompox-CRD.ja.md] の KOM 反映と用語統一
  - CLI ローダー/バリデータの `ops.kompox.dev/id` 対応(厳格検証)
  - ストア(inmem/RDB)の主キーを Resource ID に統一
  - テスト資産更新: `tests/aks-e2e-crd/` ほか CRD 依存フィクスチャ
- Out:
  - v2 Operator の実装(監視・調停)そのもの
  - 追加 Kind(ing 等)の仕様詳細(別タスク)

## 仕様サマリ

- 用語: KOM(Kompox Ops Manifest), Resource ID(alias: FQN), Kind shortnames(ws|prv|cls|app|box|…)
- ID 形式: `/ <kind> / <name> ( / <kind> / <name> )*`、先頭 `/` 必須、name は DNS-1123 label
- すべての Kind(Workspace 含む)で `metadata.annotations["ops.kompox.dev/id"]` を必須
- ハッシュは Resource ID から算出し、K8s ラベル値には短縮ハッシュを使用
- 参考: [K4x-ADR-009], [Kompox-CRD.ja.md]

## 計画 (チェックリスト)

- [ ] 前提合意と準備
  - [ ] [K4x-ADR-009] の最終化: status を accepted へ(合意後)
  - [ ] 用語・記法の最終確認 (Resource ID/FQN/Kind shortnames)
- [ ] ドキュメントとスキーマ整備
  - [ ] [Kompox-CRD.ja.md] を KOM に全面更新 (フィールド仕様・例・禁止事項)
  - [ ] 旧 `ops.kompox.dev/path` 廃止を明記し、移行ガイドを追記
- [ ] CLI ローダー/バリデータ実装
  - [ ] Resource ID パーサ実装 `/kind/name(…)*`
  - [ ] 厳格バリデーション: kind/name/DNS-1123/親チェーン
  - [ ] `ops.kompox.dev/id` を必須化し、欠落時は明確なエラーにする
  - [ ] 単体テスト: 正常/異常系の追加
- [ ] ストア (inmem/RDB) 主キー統一
  - [ ] スキーマ更新: 主キーを Resource ID に変更
  - [ ] 一意制約・インデックスの追加
  - [ ] 既存コードの参照キーを Resource ID に置換
- [ ] ハッシュ/ラベルユーティリティ更新
  - [ ] 入力を Resource ID に変更
  - [ ] K8s ラベル値向け短縮ハッシュ生成の統一
  - [ ] 影響箇所のテスト更新
- [ ] テスト資産更新
  - [ ] `tests/aks-e2e-crd/` の CRD/YAML フィクスチャを `ops.kompox.dev/id` に統一
  - [ ] 旧 `ops.kompox.dev/path` を含む YAML の検出とエラー化を確認
- [ ] CLI ヘルプ/エラーメッセージ整備
  - [ ] 用語を Resource ID に統一
  - [ ] 例示の更新
- [ ] ドキュメント索引再生成
  - [ ] `make gen-index`
- [ ] 検証
  - [ ] `make build`/`make test` が PASS
  - [ ] E2E: `tests/aks-e2e-crd/` が KOM スキーマで成功

## テスト

- ユニット:
  - ID パーサ/バリデータ: 正常系/異常系(kind 不一致、先頭スラ無し、DNS-1123 違反、親チェーン不整合)
  - ハッシュ関数: 同一 ID -> 同一ハッシュ、異なる ID -> 高確率で異なるハッシュ
- スモーク/E2E:
  - [tests/aks-e2e-crd/] : `ops.kompox.dev/id` での取り込み・選択・デプロイが成功
  - 旧 `ops.kompox.dev/path` を含む YAML がある場合は検出してエラー

## 受け入れ条件

- `make build`/`make test` が PASS
- `tests/aks-e2e-crd/` が KOM スキーマで動作し、`ops.kompox.dev/path` 不使用
- 主要ドキュメント([K4x-ADR-009]/CRD spec)が KOM と Resource ID に整合

## メモ

- 互換性: 後方互換性は不要。必要なら独立ツールでの変換スクリプトを検討
- リスク: 参照不整合やフィクスチャ漏れによる E2E 失敗
- フォローアップ: 追加 Kind(ing)の ID ルール定義、Operator 側のウォッチ/ラベル整備

## 進捗

- 2025-10-15: タスク作成

## 参考

- [K4x-ADR-009]
- [Kompox-CRD.ja.md]
- [tests/aks-e2e-crd/]

[K4x-ADR-009]: ../../design/adr/K4x-ADR-009.md
[Kompox-CRD.ja.md]: ../../design/v1/Kompox-CRD.ja.md
[tests/aks-e2e-crd/]: ../../tests/aks-e2e-crd/
