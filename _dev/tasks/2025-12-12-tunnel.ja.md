---
id: 2025-12-12-tunnel
title: kompoxops app tunnel コマンド実装
status: active
updated: 2025-12-12
language: ja
owner: yaegashi
---
# Task: kompoxops app tunnel コマンド実装

## 目的

- `kompoxops app port-forward` を `kompoxops app tunnel` にリネームし、サブシェルコマンド実行機能を追加する。
- ポート指定を位置引数から `-p, --port` フラグに変更し、複数回指定可能にする。
- トンネル確立後にサブシェルでコマンドを実行し、終了時に自動でトンネルを閉じる機能を提供する。

## スコープ / 非スコープ

- In:
  - コマンド名を `tunnel` に変更 (エイリアス: `port-forward`, `pf`)
  - ポート指定を `-p, --port` フラグに変更 (複数回指定可)
  - サブシェルコマンド実行機能 (`-- command [args...]`)
  - トンネル確立待機 (接続可能になるまでサブシェル起動を待機)
  - 環境変数エクスポート (`KOMPOX_TUNNEL_HOST`, `KOMPOX_TUNNEL_PORT_<remotePort>`)
  - `-q, --quiet` フラグ (ログ抑制)
  - インタラクティブモード (コマンド未指定時は `Forwarding from ...` 表示して Ctrl+C 待機)
- Out:
  - `--wait-ready` フラグ (トンネル確立待機は既定動作とする)

## 仕様サマリ

[Kompox-CLI.ja.md] の `kompoxops app tunnel` セクションに準拠する。

### 使用法

```
kompoxops app tunnel -A <appName> [--component COMPONENT] [-S SERVICE] [--address ADDR] [-q] -p PORT... [-- command [args...]]
```

### オプション

| オプション | 説明 |
|------------|------|
| `-p, --port` | ポートマッピング (複数回指定可、必須) |
| `--component` | 対象の component ラベル値 (既定: `app`、`box` で Kompox Box に接続) |
| `-S, --service` | 対象の Compose service 名 (`--component=app` 時のみ有効) |
| `--address` | 待ち受けアドレス (既定: `localhost`、カンマ区切りで複数指定可) |
| `-q, --quiet` | ログ出力を抑制 (`Forwarding from ...` メッセージを表示しない) |

### ポート指定形式

| 形式 | 説明 |
|------|------|
| `8080:80` | ローカル 8080 → リモート 80 |
| `8080` | ローカル 8080 → リモート 8080 (同じポート) |
| `:80` | ローカル自動割当 → リモート 80 |

### 環境変数

サブシェルに以下の環境変数が設定される:

| 変数名 | 説明 |
|--------|------|
| `KOMPOX_TUNNEL_HOST` | 待ち受けアドレス (既定: `localhost`) |
| `KOMPOX_TUNNEL_PORT_<remotePort>` | リモートポートに対応するローカルポート番号 |

例: `-p 8080:80 -p 2222:22` の場合
- `KOMPOX_TUNNEL_HOST=localhost`
- `KOMPOX_TUNNEL_PORT_80=8080`
- `KOMPOX_TUNNEL_PORT_22=2222`

### 挙動

- アプリの Namespace 内で `app.kubernetes.io/component=<COMPONENT>` ラベルを持つ Pod を対象とする。
- Ready 状態の Pod を優先し、無ければ非終了中の Pod を選択する。
- `--` 以降にコマンドを指定すると、トンネル接続可能になるまで待機後、サブシェルで実行する。
- コマンド終了時にトンネルを自動で閉じ、コマンドの終了コードを返す。
- コマンド未指定時は `Forwarding from HOST:PORT to PORT` を表示し、Ctrl+C で終了するまで待機する。

## 計画 (チェックリスト)

- [ ] `usecase/app/port_forward.go` を `usecase/app/tunnel.go` にリネーム
  - [ ] `app.PortForward` を `app.Tunnel` に書き換え
  - [ ] `PortForwardInput` を `TunnelInput` に書き換え
  - [ ] `PortForwardOutput` を `TunnelOutput` に書き換え
  - [ ] 入力構造体に `Quiet bool` と `Command []string` を追加
  - [ ] トンネル確立待機ロジックを実装
  - [ ] サブシェル実行ロジックを実装
  - [ ] 環境変数 (`KOMPOX_TUNNEL_*`) の設定
  - [ ] コマンド終了コードの伝播
- [ ] `cmd/kompoxops/cmd_app.go` のコマンド定義を更新
  - [ ] `main.newCmdAppPortForward` を `main.newCmdAppTunnel` に書き換え
  - [ ] コマンド名を `tunnel` に変更
  - [ ] エイリアス `port-forward`, `pf` を登録
  - [ ] `-p, --port` フラグを追加 (StringArray)
  - [ ] `-q, --quiet` フラグを追加
  - [ ] 位置引数から `--` 以降をサブシェルコマンドとして取得
- [ ] 単体テスト更新 (`usecase/app/tunnel_test.go`)
  - [ ] 既存のポート指定パーステストを維持
  - [ ] 環境変数生成ロジックのテスト追加
- [ ] 統合テスト (手動確認)
  - [ ] `tunnel -p 8080 -- curl http://localhost:8080` の動作確認
  - [ ] 環境変数 `$KOMPOX_TUNNEL_PORT_80` の参照確認
  - [ ] `-q` によるログ抑制確認
  - [ ] インタラクティブモードの Ctrl+C 終了確認

## 受け入れ条件

- `kompoxops app tunnel -p 8080:80` でアプリ Pod にポートフォワードできる。
- `kompoxops app port-forward -p 8080` (エイリアス) が動作する。
- `kompoxops app pf -p 8080` (エイリアス) が動作する。
- `kompoxops app tunnel -p 8080 -- curl http://localhost:8080` でトンネル経由のコマンド実行後に自動終了する。
- トンネル確立前にコマンドが起動されない (接続可能になるまで待機)。
- サブシェルで `KOMPOX_TUNNEL_HOST` と `KOMPOX_TUNNEL_PORT_<remotePort>` が参照できる。
- `-q` 指定で `Forwarding from ...` メッセージが表示されない。
- コマンドの終了コードがそのまま CLI の終了コードになる。
- インタラクティブモードで Ctrl+C により正常終了する。

## メモ

- 既存の `2025-12-12-port-forward` タスクを置き換える。
- ポート指定が `-p` フラグになったことで、位置引数がサブシェルコマンド専用になり構文が明確になる。
- トンネル確立待機は、ローカルポートに接続可能になるまでポーリングする実装を検討。

## 進捗

- 2025-12-12: タスク作成

## 参考

- [Kompox-CLI.ja.md]
- [usecase/app/port_forward.go]
- [adapters/kube/client_port_forward.go]

[Kompox-CLI.ja.md]: ../../design/v1/Kompox-CLI.ja.md
[usecase/app/port_forward.go]: ../../usecase/app/port_forward.go
[adapters/kube/client_port_forward.go]: ../../adapters/kube/client_port_forward.go
