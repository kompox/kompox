---
id: 2025-12-12-tunnel
title: kompoxops app tunnel コマンド実装
status: done
updated: 2025-12-12
language: ja
owner: yaegashi
---
# Task: kompoxops app tunnel コマンド実装

## 目的

- `kompoxops app port-forward` を `kompoxops app tunnel` にリネームし、サブシェルコマンド実行機能を追加する。
- ポート指定を位置引数から `-p, --port` フラグに変更し、複数回指定可能にする。
- トンネル確立後にサブシェルでコマンドを実行し、終了時に自動でトンネルを閉じる機能を提供する。

## スコープ / 非スコープ

- In:
  - コマンド名を `tunnel` に変更 (エイリアス: `port-forward`, `pf`)
  - ポート指定を `-p, --port` フラグに変更 (複数回指定可)
  - サブシェルコマンド実行機能 (`-- command [args...]`)
  - トンネル確立待機 (接続可能になるまでサブシェル起動を待機)
  - 環境変数エクスポート (`KOMPOX_TUNNEL_HOST`, `KOMPOX_TUNNEL_PORT_<remotePort>`)
  - `-q, --quiet` フラグ (ログ抑制)
  - インタラクティブモード (コマンド未指定時は `Forwarding from ...` 表示して Ctrl+C 待機)
- Out:
  - `--wait-ready` フラグ (トンネル確立待機は既定動作とする)

## 仕様サマリ

[Kompox-CLI.ja.md] の `kompoxops app tunnel` セクションに準拠する。

### 使用法

```
kompoxops app tunnel -A <appName> [--component COMPONENT] [-S SERVICE] [--address ADDR] [-q] -p PORT... [-- command [args...]]
```

### オプション

| オプション | 説明 |
|------------|------|
| `-p, --port` | ポートマッピング (複数回指定可、必須) |
| `--component` | 対象の component ラベル値 (既定: `app`、`box` で Kompox Box に接続) |
| `-S, --service` | 対象の Compose service 名 (`--component=app` 時のみ有効) |
| `--address` | 待ち受けアドレス (既定: `localhost`、カンマ区切りで複数指定可) |
| `-q, --quiet` | ログ出力を抑制 (`Forwarding from ...` メッセージを表示しない) |

### ポート指定形式

| 形式 | 説明 |
|------|------|
| `8080:80` | ローカル 8080 → リモート 80 |
| `8080` | ローカル 8080 → リモート 8080 (同じポート) |
| `:80` | ローカル自動割当 → リモート 80 |

### 環境変数

サブシェルに以下の環境変数が設定される:

| 変数名 | 説明 |
|--------|------|
| `KOMPOX_TUNNEL_HOST` | 待ち受けアドレス (既定: `localhost`) |
| `KOMPOX_TUNNEL_PORT_<remotePort>` | リモートポートに対応するローカルポート番号 |

例: `-p 8080:80 -p 2222:22` の場合
- `KOMPOX_TUNNEL_HOST=localhost`
- `KOMPOX_TUNNEL_PORT_80=8080`
- `KOMPOX_TUNNEL_PORT_22=2222`

### 挙動

- アプリの Namespace 内で `app.kubernetes.io/component=<COMPONENT>` ラベルを持つ Pod を対象とする。
- Ready 状態の Pod を優先し、無ければ非終了中の Pod を選択する。
- `--` 以降にコマンドを指定すると、トンネル接続可能になるまで待機後、サブシェルで実行する。
- コマンド終了時にトンネルを自動で閉じ、コマンドの終了コードを返す。
- コマンド未指定時は `Forwarding from HOST:PORT to PORT` を表示し、Ctrl+C で終了するまで待機する。

## 計画 (チェックリスト)

- [x] `usecase/app/port_forward.go` を `usecase/app/tunnel.go` にリネーム
  - [x] `app.PortForward` を `app.Tunnel` に書き換え
  - [x] `PortForwardInput` を `TunnelInput` に書き換え
  - [x] `PortForwardOutput` を `TunnelOutput` に書き換え
  - [x] 入力構造体に `Quiet bool` と `Command []string` を追加
  - [x] トンネル確立待機ロジックを実装
  - [x] サブシェル実行ロジックを実装
  - [x] 環境変数 (`KOMPOX_TUNNEL_*`) の設定
  - [x] コマンド終了コードの伝播
- [x] `cmd/kompoxops/cmd_app.go` のコマンド定義を更新
  - [x] `main.newCmdAppPortForward` を `main.newCmdAppTunnel` に書き換え
  - [x] コマンド名を `tunnel` に変更
  - [x] エイリアス `port-forward`, `pf` を登録
  - [x] `-p, --port` フラグを追加 (StringArray)
  - [x] `-q, --quiet` フラグを追加
  - [x] 位置引数から `--` 以降をサブシェルコマンドとして取得
- [x] 単体テスト更新 (`usecase/app/tunnel_test.go`)
  - [x] 既存のポート指定パーステストを維持
  - [x] 環境変数生成ロジックのテスト追加
- [x] 統合テスト (手動確認)
  - [x] `tunnel -p 8080 -- curl http://localhost:8080` の動作確認
  - [x] 環境変数 `$KOMPOX_TUNNEL_PORT_80` の参照確認
  - [x] `-q` によるログ抑制確認
  - [x] インタラクティブモードの Ctrl+C 終了確認

## 受け入れ条件

- `kompoxops app tunnel -p 8080:80` でアプリ Pod にポートフォワードできる。
- `kompoxops app port-forward -p 8080` (エイリアス) が動作する。
- `kompoxops app pf -p 8080` (エイリアス) が動作する。
- `kompoxops app tunnel -p 8080 -- curl http://localhost:8080` でトンネル経由のコマンド実行後に自動終了する。
- トンネル確立前にコマンドが起動されない (接続可能になるまで待機)。
- サブシェルで `KOMPOX_TUNNEL_HOST` と `KOMPOX_TUNNEL_PORT_<remotePort>` が参照できる。
- `-q` 指定で `Forwarding from ...` メッセージが表示されない。
- コマンドの終了コードがそのまま CLI の終了コードになる。
- インタラクティブモードで Ctrl+C により正常終了する。

## メモ

- 既存の `2025-12-12-port-forward` タスクを置き換える。
- ポート指定が `-p` フラグになったことで、位置引数がサブシェルコマンド専用になり構文が明確になる。
- トンネル確立待機は、ローカルポートに接続可能になるまでポーリングする実装を検討。

## 進捗

- 2025-12-12: タスク作成
- 2025-12-12: 実装完了
  - `usecase/app/port_forward.go` を `usecase/app/tunnel.go` にリネーム
  - `TunnelInput` / `TunnelOutput` / `Tunnel()` に書き換え
  - サブシェル実行、環境変数設定、トンネル確立待機を実装
  - `cmd_app.go` を更新 (tunnel コマンド、エイリアス、-p/-q フラグ)
  - 単体テスト追加 (`TestBuildTunnelEnvVars`)
- 2025-12-12: 統合テスト完了 (aks-e2e-basic)
  - サブシェル実行 + 環境変数参照 ✅
  - `-q` フラグでログ抑制 ✅
  - `port-forward` / `pf` エイリアス ✅
  - 複数ポート指定 ✅
  - コマンド終了コード伝播 ✅
  - インタラクティブモード ✅

## port-forward からの発展経緯

[2025-12-12-port-forward] タスク完了後、統合テストの過程で以下の課題が明らかになった:

1. **テストの困難**: ポートフォワードを維持しながら別プロセスで curl 等を実行する必要があり、バックグラウンドプロセス管理が煩雑
2. **CI/CD での実用性**: 自動化スクリプトで「トンネル確立 → コマンド実行 → トンネル終了」を1コマンドで行いたい
3. **命名の再考**: `kubectl port-forward` の命名に引きずられていたが、サブシェル実行を含む機能は「トンネル」の方が本質を表す

これらの課題を解決するため本タスクを作成し、以下の機能を追加:

- コマンド名を `tunnel` に変更 (エイリアス: `port-forward`, `pf`)
- ポート指定を `-p, --port` フラグに変更 (位置引数はサブシェルコマンド用に開放)
- サブシェル実行機能 (`-- command [args...]`)
- 環境変数エクスポート (`KOMPOX_TUNNEL_HOST`, `KOMPOX_TUNNEL_PORT_<remotePort>`)
- トンネル確立待機 (接続可能になるまでサブシェル起動を待機)

結果として、DB 初期化や API テストなど Pod 内サーバへの接続を伴う自動化が大幅に簡素化された:

```bash
# 従来: 2つのターミナルまたはバックグラウンドプロセス管理が必要
$ kompoxops app port-forward -A myapp 8080:80 &
$ curl http://localhost:8080
$ kill %1

# tunnel: 1コマンドで完結
$ kompoxops app tunnel -A myapp -p :80 -- curl http://localhost:$KOMPOX_TUNNEL_PORT_80
```

## 参考

- [Kompox-CLI.ja.md]
- [usecase/app/tunnel.go]
- [adapters/kube/client_port_forward.go]

[Kompox-CLI.ja.md]: ../../design/v1/Kompox-CLI.ja.md
[usecase/app/tunnel.go]: ../../usecase/app/tunnel.go
[adapters/kube/client_port_forward.go]: ../../adapters/kube/client_port_forward.go
[2025-12-12-port-forward]: ./2025-12-12-port-forward.ja.md
