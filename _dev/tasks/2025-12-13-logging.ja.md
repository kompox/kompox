---
id: 2025-12-13-logging
title: CLI ロギング戦略実装 (K4x-ADR-016)
status: draft
updated: 2025-12-13
language: ja
owner:
---
# Task: CLI ロギング戦略実装 (K4x-ADR-016)

## 目的

- [K4x-ADR-016] で決定したファイルベースのロギング戦略を実装する。
- 構造化ログを既定でファイル出力し、コンソールへのノイズを排除する。
- エラー終了時にログファイルパスを表示し、デバッグを容易にする。
- `kompoxops init` でログディレクトリと .gitignore を自動作成する。

## スコープ / 非スコープ

- In:
  - `--log-format`, `--log-level`, `--log-output` フラグの実装
  - 環境変数 `KOMPOX_LOG_DIR`, `KOMPOX_LOG_FORMAT`, `KOMPOX_LOG_LEVEL`, `KOMPOX_LOG_OUTPUT` の対応
  - `.kompox/config.yml` の `logging` セクション読み込み
  - ログファイル自動生成 (`kompoxops-YYYYMMDD-HHMMSS-sss.log`)
  - エラー終了時のログファイルパス表示
  - `kompoxops init` での `.kompox/logs/` と `.kompox/.gitignore` 作成
  - ログファイル保持期間 (7日) の実装
- Out:
  - 既存のログパターン (Event/Span/Step) の変更 (既に [2025-10-24-logging.ja.md] で実装済み)
  - ログローテーションの高度な機能
  - リモートログ転送

## 仕様サマリ

### ログ出力制御フラグ

| フラグ | 説明 | 既定値 |
|--------|------|--------|
| `--log-format` | ログ形式 (`json` / `human`) | `json` |
| `--log-level` | 最小ログレベル (`DEBUG` / `INFO` / `WARN` / `ERROR`) | `INFO` |
| `--log-output` | 出力先 (パス / `-` / `none`) | 自動生成ファイル |

### --log-output の値

| 値 | 動作 |
|----|------|
| (空/省略) | `$KOMPOX_LOG_DIR/kompoxops-YYYYMMDD-HHMMSS-sss.log` に出力 |
| `<path>` | 指定パスに出力 (絶対または `$KOMPOX_LOG_DIR` 相対) |
| `-` | stderr に出力 |
| `none` | ログ出力を無効化 |

### エラー終了時の動作

```
Error: deployment failed: manifest validation error
See log file for details: /path/to/project/.kompox/logs/kompoxops-20251213-095105-123.log
```

### ファイル命名

- 形式: `kompoxops-YYYYMMDD-HHMMSS-sss.log`
- タイムゾーン: UTC
- 例: `kompoxops-20251213-095105-123.log`

詳細は [K4x-ADR-016]、[Kompox-CLI.ja.md]、[Kompox-Logging.ja.md] を参照。

## 計画 (チェックリスト)

### Phase 1: 基盤整備

- [ ] `internal/logging` パッケージにログ出力先設定機能を追加
  - [ ] `LogConfig` 構造体 (format, level, output, dir)
  - [ ] ファイル名生成関数 (UTC タイムスタンプ + ミリ秒)
  - [ ] ファイルオープン/クローズのライフサイクル管理
- [ ] `config/kompoxenv` パッケージに `logging` セクション読み込みを追加

### Phase 2: CLI フラグ実装

- [ ] `cmd/kompoxops/root.go` にログ関連フラグを追加
  - [ ] `--log-format`
  - [ ] `--log-level`
  - [ ] `--log-output`
- [ ] 環境変数からのフォールバック読み込み
- [ ] `.kompox/config.yml` からのフォールバック読み込み
- [ ] フラグ → 環境変数 → config.yml → 既定値 の優先順位を実装

### Phase 3: ログ出力の切り替え

- [ ] 既定でファイル出力に変更 (現在の stderr 出力を置換)
- [ ] `--log-output -` で stderr 出力
- [ ] `--log-output none` で出力抑制
- [ ] 相対パス指定時の `$KOMPOX_LOG_DIR` 基準解決

### Phase 4: エラー終了時の動作

- [ ] エラー終了時にログファイルパスを stderr に表示
- [ ] ログファイルが生成されていない場合 (`--log-output none`) はメッセージを省略

### Phase 5: kompoxops init 更新

- [ ] `.kompox/logs/` ディレクトリ作成
- [ ] `.kompox/.gitignore` 作成 (内容: `/logs`)
- [ ] 既存の `.gitignore` がある場合はスキップ

### Phase 6: ログファイル保持

- [ ] CLI 起動時に古いログファイルを削除 (既定: 7日)
- [ ] `logging.retentionDays` 設定の読み込み

### Phase 7: テスト

- [ ] ユニットテスト
  - [ ] ログファイル名生成
  - [ ] 設定優先順位
  - [ ] 保持期間削除ロジック
- [ ] 統合テスト
  - [ ] ファイル出力確認
  - [ ] エラー終了時のメッセージ確認
  - [ ] `kompoxops init` でのディレクトリ/.gitignore 作成

## 受け入れ条件

1. `kompoxops app deploy` 実行時、既定で `$KOMPOX_DIR/logs/` に JSON Lines ログファイルが生成される
2. ログファイル名が `kompoxops-YYYYMMDD-HHMMSS-sss.log` 形式 (UTC) である
3. `--log-output -` で stderr にログが出力される
4. `--log-output none` でログ出力が抑制される
5. エラー終了時、stderr にログファイルのフルパスが表示される
6. `kompoxops init` で `.kompox/logs/` と `.kompox/.gitignore` が作成される
7. 7日以上前のログファイルが CLI 起動時に削除される
8. 並列実行時にログファイルが混在しない (ミリ秒精度のタイムスタンプで分離)

## メモ

- `-v`, `--verbose`, `--debug` フラグは構造化ログ出力に影響しない。各コマンドが独自に解釈する。
- 既存の [2025-10-24-logging.ja.md] タスクとの関係: 本タスクはログの「出力先」を扱い、既存タスクはログの「パターン」を扱う。

## 進捗

- 2025-12-13: タスク作成

## 参考

- [K4x-ADR-016]
- [K4x-ADR-015]
- [Kompox-CLI.ja.md]
- [Kompox-Logging.ja.md]
- [2025-10-24-logging.ja.md]

[K4x-ADR-016]: ../../design/adr/K4x-ADR-016.md
[K4x-ADR-015]: ../../design/adr/K4x-ADR-015.md
[Kompox-CLI.ja.md]: ../../design/v1/Kompox-CLI.ja.md
[Kompox-Logging.ja.md]: ../../design/v1/Kompox-Logging.ja.md
[2025-10-24-logging.ja.md]: ./2025-10-24-logging.ja.md
