---
id: 2025-10-13-crd-p1
title: CRD DTO とローダーの初期実装（ops.kompox.dev/v1alpha1）
status: done
updated: 2025-10-13
language: ja
owner: yaegashi
---
# Task: CRD DTO とローダーの初期実装（ops.kompox.dev/v1alpha1）

## 目的

- [K4x-ADR-007]（CRD-style configuration）に基づき、CLI 側で扱う CRD 互換 DTO（Workspace/Provider/Cluster/App/Box）とローダーの骨子を実装する。
- v1 CLI の「フォルダスキャン → 検証 → インデックス構築」フローを成り立たせ、今後の RDB 実装・CLI サブコマンド拡張の土台とする。

## スコープ / 非スコープ

- In:
  - Go パッケージ `config/crd/ops/v1alpha1` の新規作成（package 名: `v1alpha1`）
  - DTO 定義（TypeMeta/ObjectMeta を含むシリアライズ用構造体）
    - Kind: Workspace / Provider / Cluster / App / Box（Box はプレースホルダで OK）
  - ローダー（ディレクトリ再帰・マルチドキュメント YAML 対応）
    - `metadata.annotations["ops.kompox.dev/path"]` のみを略記として受理
    - 検証順序: Workspace → Provider → Cluster → App → Box
    - 失敗時はオール・オア・ナッシング（インデックス構築前に全検証）
  - イミュータブル読み込み専用インデックス（Sink）。FQN を主キーとして保持。
  - **複数ソース対応**: CLI で複数設定ファイル/ディレクトリを受け取る際の段階的ロード
    - Document.Path: ドキュメントの読み込み元ファイルパス
    - Document.Index: マルチドキュメント YAML 内での位置（1-based）
    - ValidationError への Path/Index 統合（エラー箇所の明確化）
- Out:
  - RDB 実装
  - CLI サブコマンドの実装（import/plan/app/box 等）
  - Operator/CRD の実際の K8s 適用

## 仕様サマリ

- Group: `ops.kompox.dev` / Version: `v1alpha1`
- Kind: `Workspace | Provider | Cluster | App | Box`
- ポータブル YAML（import 用）:
  - 唯一の略記: `metadata.annotations["ops.kompox.dev/path"] = "<ws>/<prv>/<cls>[/<app>[/<box>]]"`
  - 各 Kind の FQN（正規 ID）:
    - Workspace: `ws`
    - Provider: `ws/prv`
    - Cluster: `ws/prv/cls`
    - App: `ws/prv/cls/app`
    - Box: `ws/prv/cls/app/box`
- 検証: 親存在確認、セグメント数確認、同名衝突、DNS-1123 ラベル制約
- 反映: 全検証 OK の場合のみ一括コミット
- **エラー報告**: 検証エラーにファイルパスとドキュメント位置を含める
  - 例: `provider "ws1/prv1" validation error: parent "ws1" does not exist from /path/to/config.yaml (document 2)`

参考: [K4x-ADR-007], [Kompox-CRD.ja.md], [config/crd/ops/v1alpha1/README.md]

## 計画(チェックリスト)

- [x] パッケージ雛形の追加: `config/crd/ops/v1alpha1`(Go modules に追従)
- [x] DTO 定義: GVK/TypeMeta/ObjectMeta + Spec スケルトン(Box は空構造体で可)
- [x] FQN/Path ユーティリティ: 解析/検証/正規化(DNS-1123 チェッカー含む)
- [x] ローダー実装: ディレクトリ再帰 + マルチドキュメント YAML デコード
- [x] 検証ロジック: トポロジ順に親解決・重複検出・エラー収集
- [x] イミュータブル読み込み専用インデックス(Sink): All-or-nothing 構築
- [x] 複数ソース対応: Path/Index フィールドとエラー報告の改善
- [x] 単体テスト: Happy path + 代表的なエラーケース(親なし/重複/不正 path)
- [x] API ドキュメント: README.md with usage examples
- [x] Make ターゲット(必要最小限。現行 `make test/build` で動く範囲)

## テスト

- ユニット:
  - Workspace→Provider→Cluster→App→Box の順での投入で正常に FQN 化され、inmem へコミットされる
  - 親の欠落や path セグメント不一致がある場合、コミットされない
  - DNS-1123 違反を検出してエラーになる
- スモーク:
  - `tests/` に簡単な YAML セットを置き、ローダー API でステージング→コミットが動くことを確認

## 受け入れ条件

- `config/crd/ops/v1alpha1` に DTO/ローダー/読み込み専用インデックスの初期実装が存在する
- `make build && make test` がローカルで成功する
- Happy path と 2〜3 の代表的なエラーケースのテストがグリーン

## メモ

- Box は未実装のため Spec は空 or Name のみの軽量プレースホルダで開始。後続 ADR-008 にて詳細化。
- 将来 RDB 化する際は、FQN UNIQUE + UUID PK への移行も想定（現時点では inmem 前提）。

## 進捗

**2025-10-13: 完了 ✅**

全チェックリスト項目を完了し、`config/crd/ops/v1alpha1` パッケージの実装を完成させた。

**主要成果物:**
- **DTO・FQN ユーティリティ**: TypeMeta/ObjectMeta を含む CRD スタイル型定義、DNS-1123 バリデーション
- **ステートレス Loader**: ディレクトリ再帰・マルチドキュメント YAML 対応、非 Kompox ドキュメントのスキップ
- **Validator**: トポロジカルソート、親存在確認、重複検出、包括的エラー収集
- **イミュータブル Sink**: 検証済みドキュメントの読み込み専用インデックス、FQN ベース Get/List API
- **複数ソース対応**: Document.Path/Index フィールドによるエラー箇所の特定
  - マルチドキュメント YAML でのドキュメント位置追跡（1-based indexing）
  - ValidationError に Path/Index を統合し、エラーメッセージに含める
- **包括的テストカバレッジ**: 35 単体テスト（Happy path + エラーケース）

**設計の進化:**
- 初期設計から3回のリファクタリングを経て、CLI 起動時ユースケースに最適化
- ステージング/コミットパターンからイミュータブル構築パターンへ移行
- エラー報告の改善: ファイルパスとドキュメント位置を含む詳細なエラーメッセージ

**テスト結果:** 全 35 テスト成功、`make build && make test` グリーン

詳細: [config/crd/ops/v1alpha1/README.md]

## 参考

- [K4x-ADR-007]
- [Kompox-CRD.ja.md]
- [config/crd/ops/v1alpha1/README.md]

[K4x-ADR-007]: ../../design/adr/K4x-ADR-007.md
[Kompox-CRD.ja.md]: ../../design/v1/Kompox-CRD.ja.md
[config/crd/ops/v1alpha1/README.md]: ../../config/crd/ops/v1alpha1/README.md
