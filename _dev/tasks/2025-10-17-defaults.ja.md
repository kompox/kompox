---
id: 2025-10-17-defaults
title: KOM 命名統一(CRD→KOM)と Defaults 実装
status: done
updated: 2025-10-17
language: ja
owner: yaegashi
---
# Task: KOM 命名統一(CRD→KOM)と Defaults 実装

## 目的

- 用語/フラグ/ドキュメントを「CRD」から「KOM」へ統一する(後方互換なし)。
- kompoxapp.yml に kind: Defaults を用いて、
  - 読み込む KOM のローカルパス集合(`spec.komPath`)
  - 既定の App ID(`spec.appId`)
  を宣言できるようにする。
- Include 多重インクルードを廃止し、単一エントリポイント(= Kompox アプリファイル)で安全かつ再現性の高いロードを実現する。

## スコープ / 非スコープ

- In:
  - 命名統一(KOM): 用語/ドキュメント更新、ファイル名変更、`--kom-*`/`KOMPOX_KOM_*` の新設、旧 `--crd-*`/`KOMPOX_CRD_*` の廃止(指定時エラー)
  - Defaults のパース(ローダー/CLI フロントエンド)
  - `komPath` のローカルのみ・ワイルドカード不可・ディレクトリ再帰・相対は kompoxapp.yml 基準
  - `appId` の優先順位解決(`--app-id` > Defaults > 推論(直下に1件))
  - App のローカルFS参照ルールの検証
- Out:
  - リモート URL 対応(将来検討)
  - ワイルドカード対応(将来検討)

## 仕様サマリ

- ADR: [K4x-ADR-010] (CRD→KOM 命名統一、後方互換なし)、[K4x-ADR-011] (Defaults 導入)
- KOM 命名統一:
  - 概念: 「CRD モード」→「KOM モード」
  - フラグ/環境変数: `--kom-path`/`--kom-app`, `KOMPOX_KOM_PATH`/`KOMPOX_KOM_APP` を採用。
  - 旧 `--crd-*`/`KOMPOX_CRD_*` はサポート対象外。指定時はエラーで即時終了(後方互換なし)。
- Defaults は非永続(ローダー/CLI 専用)。
- spec.komPath: ローカルのみ、ワイルドカード不可、ディレクトリは再帰、相対は Kompox アプリファイル(kompoxapp.yml)基準。ベースルート(.git/.kompoxroot 祖先)外は不可。
- spec.appId: `--app-id` のデフォルト。
- App のローカルFS参照制約(記述は CLI ドキュメント側に集約):
  - Kompox アプリファイル直下の App のみローカル参照を許可。
  - 許可例: `file:compose.yml`、bind マウント(`./data:/data` など)、Compose の `configs`/`secrets` の `file=` 参照、`env_file:` のローカル .env。
  - Defaults.spec.komPath 由来の外部 KOM の App はローカル参照禁止(検証エラー)。
- CLI 優先順位:
  - 読み込みパス: `--kom-path` > `KOMPOX_KOM_PATH` > Defaults.spec.komPath > Kompox アプリファイル内の KOM リソース
  - 既定 App: `--app-id` > Defaults.spec.appId > kompoxapp.yml 直下の App が1件のみならそれ

## 計画（チェックリスト）

優先順位: まず「CRD→KOM」の用語・ファイル名・フラグを完了し、その後に Defaults を実装・適用します。

- [x] フェーズA: 命名統一(KOM)
  - [x] ADR-010 最終化(本内容どおり: accepted, 後方互換なしを明記)
  - [x] ドキュメント: [Kompox-CRD.ja.md] を [Kompox-KOM.ja.md] にリネームし、本文の「CRD」を「KOM」へ置換、`--kom-*` 表記へ統一 (旧ファイルは Notice のみ/archived)
  - [x] ドキュメント: [Kompox-CLI.ja.md] を KOM モード/`--kom-*` 基準にリライト(旧フラグは記載しない)
  - [x] インデックス再生成(`make gen-index`)
  - [x] CLI 実装: `--kom-path`/`--kom-app` と `KOMPOX_KOM_*` を追加し、旧 `--crd-*`/`KOMPOX_CRD_*` を完全削除(ヘルプ/コードから痕跡排除)

- [x] フェーズB: Defaults 実装
  - [x] Defaults パーサ実装（kompoxapp.yml から 1件のみ許容）
  - [x] komPath 解決（絶対化、存在/型チェック、ディレクトリ再帰、YAML のみ）
  - [x] ローダー統合（visited 去重、サイズ上限）
  - [x] デフォルト App 選定ロジック実装
  - [x] 検証: ローカルFS参照の可否(直下 App のみ許可)
  - [x] ドキュメント更新:
    - 設計(KOM): Defaults を「Kompox アプリファイル」用語で記述し、仕様(スキーマ)と例を分離。例は単一コードブロックにまとめた `komPath` 配列でパターンを例示。ローカルFS制約の記述は削除。
    - CLI: Defaults リソースは仕様参照のみ(重複なし)。ローカルFS制約に Compose の `configs`/`secrets`/`env_file` まで明記。

- [x] フェーズC: komPath 入力要件チェックリスト
  - [x] ローカルパスのみ許可(URL不可)
  - [x] 相対/絶対の両方を許可。相対は Kompox アプリファイルのディレクトリ基準で解決
  - [x] 親ディレクトリ参照(../)を許可
  - [x] 解決手順: path.Clean と EvalSymlinks を適用して実パス取得
  - [x] baseRoot 制約の実装:
    - [x] baseRoot は Kompox アプリファイルの祖先で最初に見つかる .git または .kompoxroot を含むディレクトリ
    - [x] いずれも見つからない場合は Kompox アプリファイルの親ディレクトリを baseRoot とする
    - [x] 解決済み実パスは baseRoot 配下にあることを強制
  - [x] ディレクトリは再帰的に走査し、.yml/.yaml のみを対象
  - [x] 無視パス: .git/ .github/ node_modules/ vendor/ .direnv/ .venv/ dist/ build/
  - [x] グロブ/ワイルドカードは不可
  - [x] 去重と循環防止: 正規化済み実パスで重複を除外
  - [x] 実装上の上限を設定: 最大ファイル数 5000、1ファイル最大 2MiB、合計 32MiB、最大深さ 10
  - [x] エラー条件を検出し適切に報告:
    - [x] パスが存在しない
    - [x] 解決済み実パスが baseRoot の外側
    - [x] 対象拡張子が .yml/.yaml 以外
    - [x] 実装上限の超過

## テスト

- ユニット:
  - 新フラグ/環境変数(`--kom-*`/`KOMPOX_KOM_*`) が機能する
  - Defaults が 0/1/2 件のケース
  - komPath: 相対/絶対/ディレクトリ再帰/ファイルのみ/ワイルドカード拒否/存在エラー
  - App デフォルト選定: 優先順位どおりの決定
  - ローカルFS参照制約: 許可/禁止パターンの検証
- 統合/スモーク:
  - kompoxapp.yml + 複数 KOM ファイルの読み込み → 集約 → トポロジカルソート → 検証まで通る

## 受け入れ条件

- ドキュメント: 「KOM」用語に統一し、[Kompox-CRD.ja.md] のリネームと参照更新が完了している
- CLI: 新 `--kom-*`/`KOMPOX_KOM_*` が機能し、旧 `--crd-*`/`KOMPOX_CRD_*` は CLI から削除されている（ヘルプ/ドキュメントに痕跡がない）
- kompoxapp.yml に Defaults を記述して指定したファイル/ディレクトリが読み込まれる
- `--app-id` 未指定時、Defaults.appId があればそれが採用される
- Defaults.appId が無い場合、kompoxapp.yml 直下に App が1件のみならそれが採用される
- kompoxapp.yml 直下でない App のローカルFS参照が検出されるとエラーになる
- ワイルドカードや存在しないパスを指定した場合にエラーになる

## メモ

- 既定ではローカルのみ。リモートやワイルドカードは将来の ADR で検討。
- 直下 App の相対解決は kompoxapp.yml ディレクトリ基準で行うこと。

## 進捗

- 2025-10-17: タスク作成(このファイル)
- 2025-10-17: ADR-010 を「CRD→KOM 命名統一 (後方互換なし)」として最終化(accepted)。旧 `--crd-*`/`KOMPOX_CRD_*` はサポートしない方針を明記。
- 2025-10-17: ADR-011 (Defaults) 作成。用語/フラグ/フィールドを `--kom-*`/`komPath` に統一。
- 2025-10-17: 設計ドキュメントを更新。
  - 追加: [Kompox-KOM.ja.md] (KOM 仕様)
  - 旧: [Kompox-CRD.ja.md] は本文削除しリネーム告知のみ(archived)
  - 更新: [Kompox-CLI.ja.md] を KOM モード・新フラグ/環境変数・優先順位でリライト
- 2025-10-17: インデックス再生成を実行(`make gen-index`)。
- 2025-10-17: CLI 実装を適用。
  - `--kom-path`/`--kom-app` と `KOMPOX_KOM_*` を追加。
  - CRD 痕跡を CLI から完全削除（旧 `--crd-*` フラグ/`KOMPOX_CRD_*` 環境変数の定義・fail-fast を持たない）。
  - KOM ローダー(`initializeKOMMode`)を導入、CRD ローダー/テストを削除。
  - `crdv1` の import エイリアスを `komv1` に統一（コードの語彙を KOM で一貫化）。
  - Build/Tests: PASS。
- 2025-10-17: **フェーズB完了** Defaults 実装を完了。
  - `config/crd/ops/v1alpha1/types.go`: Defaults 型と DefaultsSpec を追加。
  - `config/crd/ops/v1alpha1/loader.go`: Defaults のパース処理を追加(Resource ID なし、kompoxapp.yml に最大1件)。
  - `config/crd/ops/v1alpha1/app_validation.go`: ローカルFS参照検出関数 `HasLocalFSReference()` を実装(file:プレフィックス、ボリュームマウントパターンを正規表現でチェック)。
  - `cmd/kompoxops/kom_loader.go`: `initializeKOMMode()` を更新。
    - Defaults.spec.komPath の解決と読み込み(相対パスは kompoxapp.yml 基準、重複除外、再帰スキャン)。
    - Defaults.spec.appId による既定 App 設定(優先順位: --app-id > Defaults > 単一 App 推定)。
    - ローカルFS参照の検証(kompoxapp.yml 外の App でのローカルFS参照を禁止)。
  - テスト: `cmd/kompoxops/kom_loader_test.go` に統合テストを追加(Defaults による読み込み、ローカルFS参照制約の検証)。全テスト PASS。
  - ドキュメント更新:
    - [Kompox-KOM.ja.md]: Defaults の仕様を「Kompox アプリファイル」前提で再編。仕様(スキーマ)と例を分離し、例は `komPath` 配列に集約。ローカルFS制約は削除。
    - [Kompox-CLI.ja.md]: Defaults は KOM 仕様への参照に限定。KOM 読み込み経路の優先順位を整理し、ローカルFS制約に `configs`/`secrets`/`env_file` を含めて明記。
- 2025-10-17: **フェーズC完了** komPath 入力要件の厳格な検証を実装。
  - `cmd/kompoxops/kom_loader.go`:
    - `findBaseRoot()`: .git または .kompoxroot を探して baseRoot を決定。
    - `validateAndResolveKOMPath()`: URL拒否、シンボリックリンク解決、baseRoot 制約、拡張子チェックを実装。
    - `scanKOMDirectory()`: 再帰スキャン、無視パターン(.git, node_modules等)、上限チェック(最大5000ファイル、1ファイル2MiB、合計32MiB、深さ10)を実装。
    - `initializeKOMMode()`: baseRoot の初期化タイミングを修正し、komAppPath が存在しない場合でも baseRoot を設定。
  - テスト追加:
    - `cmd/kompoxops/kom_loader_test.go`: baseRoot検出、パス検証、ディレクトリスキャン、baseRoot外拒否のユニットテストを追加。
    - `cmd/kompoxops/kom_integration_test.go`: 再帰スキャン、親ディレクトリ参照の統合テストを追加。既存テストを修正(baseRoot コンテキストの設定)。
  - 全テスト PASS。ビルド成功。


## 参考

- [K4x-ADR-010]
- [K4x-ADR-011]
- [Kompox-CRD.ja.md] → リネーム済み: [Kompox-KOM.ja.md]
- [Kompox-CLI.ja.md]
- [Kompox-KubeConverter.ja.md]
- `make gen-index`

[K4x-ADR-010]: ../../design/adr/K4x-ADR-010.md
[K4x-ADR-011]: ../../design/adr/K4x-ADR-011.md
[Kompox-CRD.ja.md]: ../../design/v1/Kompox-CRD.ja.md
[Kompox-KOM.ja.md]: ../../design/v1/Kompox-KOM.ja.md
[Kompox-CLI.ja.md]: ../../design/v1/Kompox-CLI.ja.md
[Kompox-KubeConverter.ja.md]: ../../design/v1/Kompox-KubeConverter.ja.md
