id: 2025-10-17-defaults
title: KOM 命名統一(CRD→KOM)と Defaults 実装
status: active
updated: 2025-10-17
language: ja
owner: yaegashi
---
# Task: KOM 命名統一(CRD→KOM)と Defaults 実装

## 目的

- 用語/フラグ/ドキュメントを「CRD」から「KOM」へ統一する(後方互換なし)。
- kompoxapp.yml に kind: Defaults を用いて、
  - 読み込む KOM のローカルパス集合(`spec.komPath`)
  - 既定の App ID(`spec.appId`)
  を宣言できるようにする。
- Include 多重インクルードを廃止し、単一エントリポイントで安全かつ再現性の高いロードを実現する。

## スコープ / 非スコープ

- In:
  - 命名統一(KOM): 用語/ドキュメント更新、ファイル名変更、`--kom-*`/`KOMPOX_KOM_*` の新設、旧 `--crd-*`/`KOMPOX_CRD_*` の廃止(指定時エラー)
  - Defaults のパース(ローダー/CLI フロントエンド)
  - `komPath` のローカルのみ・ワイルドカード不可・ディレクトリ再帰・相対は kompoxapp.yml 基準
  - `appId` の優先順位解決(`--app-id` > Defaults > 推論(直下に1件))
  - App のローカルFS参照ルールの検証
- Out:
  - リモート URL 対応(将来検討)
  - ワイルドカード対応(将来検討)

## 仕様サマリ

- ADR: [K4x-ADR-010] (CRD→KOM 命名統一、後方互換なし)、[K4x-ADR-011] (Defaults 導入)
- KOM 命名統一:
  - 概念: 「CRD モード」→「KOM モード」
  - フラグ/環境変数: `--kom-path`/`--kom-app`, `KOMPOX_KOM_PATH`/`KOMPOX_KOM_APP` を採用。
  - 旧 `--crd-*`/`KOMPOX_CRD_*` は CLI から完全削除（痕跡なし・エラー誘導もしない）。
- Defaults は非永続(ローダー/CLI 専用)。
- spec.komPath: ローカルのみ、ワイルドカード不可、ディレクトリは再帰、相対は kompoxapp.yml 基準。
- spec.appId: `--app-id` のデフォルト。
- App のローカルFS参照制約:
  - kompoxapp.yml に直接含まれる App のみ `file:compose.yml` や `./data:/data` を許可。
  - それ以外の App はローカルFS参照を禁止(検証エラー)。
- CLI 優先順位:
  - 読み込みパス: `--kom-path` > `KOMPOX_KOM_PATH` > Defaults.spec.komPath > なし
  - 既定 App: `--app-id` > Defaults.spec.appId > kompoxapp.yml 直下の App が1件のみならそれ

## 計画（チェックリスト）

優先順位: まず「CRD→KOM」の用語・ファイル名・フラグを完了し、その後に Defaults を実装・適用します。

- [ ] フェーズA: 命名統一(KOM)
  - [x] ADR-010 最終化(本内容どおり: accepted, 後方互換なしを明記)
  - [x] ドキュメント: [Kompox-CRD.ja.md] を [Kompox-KOM.ja.md] にリネームし、本文の「CRD」を「KOM」へ置換、`--kom-*` 表記へ統一(旧ファイルは Notice のみ/archived)
  - [x] ドキュメント: [Kompox-CLI.ja.md] を KOM モード/`--kom-*` 基準にリライト(旧フラグは記載しない)
  - [ ] 参照更新: ADR/Design/Tasks/README 等のリンクを新ファイル名へ一括更新
  - [x] インデックス再生成(`make gen-index`)
  - [x] CLI 実装: `--kom-path`/`--kom-app` と `KOMPOX_KOM_*` を追加し、旧 `--crd-*`/`KOMPOX_CRD_*` を完全削除（ヘルプ/コードから痕跡排除）

- [ ] フェーズB: Defaults 実装
  - [ ] Defaults パーサ実装（kompoxapp.yml から 1件のみ許容）
  - [ ] komPath 解決（絶対化、存在/型チェック、ディレクトリ再帰、YAML のみ）
  - [ ] ローダー統合（visited 去重、サイズ上限）
  - [ ] デフォルト App 選定ロジック実装
  - [ ] 検証: ローカルFS参照の可否(直下 App のみ許可)
  - [ ] ドキュメント更新(設計/CLI に Defaults 使用例を追記)

## テスト

- ユニット:
  - 新フラグ/環境変数(`--kom-*`/`KOMPOX_KOM_*`) が機能する
  - Defaults が 0/1/2 件のケース
  - komPath: 相対/絶対/ディレクトリ再帰/ファイルのみ/ワイルドカード拒否/存在エラー
  - App デフォルト選定: 優先順位どおりの決定
  - ローカルFS参照制約: 許可/禁止パターンの検証
- 統合/スモーク:
  - kompoxapp.yml + 複数 KOM ファイルの読み込み → 集約 → トポロジカルソート → 検証まで通る

## 受け入れ条件

- ドキュメント: 「KOM」用語に統一し、[Kompox-CRD.ja.md] のリネームと参照更新が完了している
- CLI: 新 `--kom-*`/`KOMPOX_KOM_*` が機能し、旧 `--crd-*`/`KOMPOX_CRD_*` は CLI から削除されている（ヘルプ/ドキュメントに痕跡がない）
- kompoxapp.yml に Defaults を記述して指定したファイル/ディレクトリが読み込まれる
- `--app-id` 未指定時、Defaults.appId があればそれが採用される
- Defaults.appId が無い場合、kompoxapp.yml 直下に App が1件のみならそれが採用される
- kompoxapp.yml 直下でない App のローカルFS参照が検出されるとエラーになる
- ワイルドカードや存在しないパスを指定した場合にエラーになる

## メモ

- 既定ではローカルのみ。リモートやワイルドカードは将来の ADR で検討。
- 直下 App の相対解決は kompoxapp.yml ディレクトリ基準で行うこと。

## 進捗

- 2025-10-17: タスク作成(このファイル)
- 2025-10-17: ADR-010 を「CRD→KOM 命名統一 (後方互換なし)」として最終化(accepted)。旧 `--crd-*`/`KOMPOX_CRD_*` はサポートしない方針を明記。
- 2025-10-17: ADR-011 (Defaults) 作成。用語/フラグ/フィールドを `--kom-*`/`komPath` に統一。
- 2025-10-17: 設計ドキュメントを更新。
  - 追加: [Kompox-KOM.ja.md] (KOM 仕様)
  - 旧: [Kompox-CRD.ja.md] は本文削除しリネーム告知のみ(archived)
  - 更新: [Kompox-CLI.ja.md] を KOM モード・新フラグ/環境変数・優先順位でリライト
- 2025-10-17: インデックス再生成を実行(`make gen-index`)。
- 2025-10-17: CLI 実装を適用。
  - `--kom-path`/`--kom-app` と `KOMPOX_KOM_*` を追加。
  - CRD 痕跡を CLI から完全削除（旧 `--crd-*` フラグ/`KOMPOX_CRD_*` 環境変数の定義・fail-fast を持たない）。
  - KOM ローダー(`initializeKOMMode`)を導入、CRD ローダー/テストを削除。
  - `crdv1` の import エイリアスを `komv1` に統一（コードの語彙を KOM で一貫化）。
  - Build/Tests: PASS。

## 参考

- [K4x-ADR-010]
- [K4x-ADR-011]
- [Kompox-CRD.ja.md] → リネーム済み: [Kompox-KOM.ja.md]
- [Kompox-CLI.ja.md]
- [Kompox-KubeConverter.ja.md]
- `make gen-index`

[K4x-ADR-010]: ../../design/adr/K4x-ADR-010.md
[K4x-ADR-011]: ../../design/adr/K4x-ADR-011.md
[Kompox-CRD.ja.md]: ../../design/v1/Kompox-CRD.ja.md
[Kompox-KOM.ja.md]: ../../design/v1/Kompox-KOM.ja.md
[Kompox-CLI.ja.md]: ../../design/v1/Kompox-CLI.ja.md
[Kompox-KubeConverter.ja.md]: ../../design/v1/Kompox-KubeConverter.ja.md
