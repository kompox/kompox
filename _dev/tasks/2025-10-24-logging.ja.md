---
id: 2025-10-24-log
title: kompoxops ログ標準化（Event/Span/Step パターン適用）
status: active
updated: 2025-10-26
language: ja
owner:
---
# Task: kompoxops ログ標準化（Event/Span/Step パターン適用）

## 目的

- kompoxops の CLI ログ出力を標準化し、Event/Span/Step の3パターンを適用する。
- 各操作の開始・終了を明確に記録し、エラーや経過時間を追跡可能にする。
- ログに一貫性のある属性（runId, resourceId など）を付与し、可観測性を向上させる。
- サフィックス形式（`/S`, `/EOK`, `/EFAIL`, `/s`, `/eok`, `/efail`）により grep での検索を効率化する。
- Span/Step は機械的記録 (`INFO`)、Event はアプリ判断 (`ERROR` 等) でログレベルを使い分ける。

詳細な仕様は [Kompox-Logging.ja.md] を参照。

## スコープ / 非スコープ

- In:
  - Event/Span/Step の3パターンを導入。
  - 全操作系コマンドの実行開始時に `/S` ログを出力（Span パターン）。
  - 成功/失敗時に `/EOK`/`/EFAIL` ログを出力（Span パターン）。
  - Azure 操作に `/s`/`/efail` ログを出力（Step パターン）。
  - アプリケーション判断を Event ログ（サフィックスなし）で記録。
  - ロガーに `runId`, `resourceId` などを属性として付与したコンテキストを下位層へ伝搬。
  - CLI レイヤー（20コマンド）と AKS ドライバーレイヤー（4メソッド + 6 Step 操作）に適用。
- Out:
  - 全レイヤーへの完全適用（現時点で主要な操作コマンドとドライバーをカバー）。
  - ログ基盤/依存パッケージの入れ替えや大規模改修。
  - ドメイン層 API 仕様の変更。

## 仕様サマリ

### 3つのログパターン

#### Event パターン

サフィックスなしの `<msgSym>` でアプリケーションイベントを記録。

- **用途**: 状態遷移、サマリー情報、判断結果など
- **ログレベル**: `DEBUG` / `INFO` / `WARN` / `ERROR` (セマンティックな判断)
- **例**: `CMD:app.deploy:Failed`

#### Span パターン

長時間実行される操作の開始・終了を記録するパターン。

- **開始**: `<msgSym>/S`
- **成功終了**: `<msgSym>/EOK`
- **失敗終了**: `<msgSym>/EFAIL`
- **ログレベル**: `DEBUG` または `INFO` のみ (機械的記録)
- **例**: `CMD:cluster.provision/S`, `CMD:cluster.provision/EOK`

#### Step パターン

短時間操作の記録パターン。成功時は終了ログを省略推奨。

- **開始**: `<msgSym>/s`
- **成功終了**: `<msgSym>/eok` (省略推奨)
- **失敗終了**: `<msgSym>/efail`
- **ログレベル**: `DEBUG` または `INFO` のみ (機械的記録)
- **例**: `AKS:RoleKV/s`, `AKS:RoleKV/efail`

詳細は [Kompox-Logging.ja.md] の各パターンセクションを参照。

### CLI レイヤー（cmd/kompoxops）

- メッセージフォーマット:
  - 開始: `CMD:<operation>/S`
  - 成功終了: `CMD:<operation>/EOK`
  - 失敗終了: `CMD:<operation>/EFAIL`
- 属性:
  - 開始時: `runId`, `resourceId`
  - 終了時: 上記 + `err`, `elapsed`
- ログレベル: すべて `INFO` (機械的記録)
- 実装: `withCmdRunLogger` 関数（[cmd/kompoxops/logging.go]）

### ドライバーレイヤー（adapters/drivers/provider/aks）

#### Span パターン（4メソッド）

- メッセージフォーマット:
  - 開始: `AKS:<method>/S`
  - 成功終了: `AKS:<method>/EOK`
  - 失敗終了: `AKS:<method>/EFAIL`
- 属性:
  - `driver` (AKS.<method>), `err`, `elapsed`
- ログレベル: すべて `INFO` (機械的記録)
- 実装: `(*driver).withMethodLogger` メソッド（[aks-logging.go]）

#### Step パターン（6操作）

- メッセージフォーマット:
  - 開始: `AKS:<operation>/s`
  - 失敗終了: `AKS:<operation>/efail`
- 属性:
  - 操作固有の属性（`principalId`, `scope`, `kvName` など）
- ログレベル: すべて `INFO` (機械的記録)
- 実装: Azure role assignment 操作に直接適用

## 計画 (チェックリスト)

- [x] CLI 共通ヘルパ `withCmdRunLogger` を実装（`cmd/kompoxops/logging.go`）。
- [x] 20 CLI コマンドに適用:
  - [x] cluster (4): provision, deprovision, install, uninstall
  - [x] app (2): deploy, destroy
  - [x] box (2): deploy, destroy
  - [x] disk (2): create, delete
  - [x] dns (2): deploy, destroy
  - [x] secret env (2): set, delete
  - [x] secret pull (2): set, delete
  - [x] snapshot (2): create, delete
- [x] AKS ドライバーメソッド `withMethodLogger` を実装（`adapters/drivers/provider/aks/logging.go`）。
- [x] AKS 4メソッドに適用: ClusterProvision, ClusterDeprovision, ClusterInstall, ClusterUninstall
- [x] Step パターンを Azure role assignment 操作に適用（6箇所）:
  - [x] azure_resources.go: Resource Group 作成 (`AKS:EnsureRG/s` / `AKS:EnsureRG/efail`)
  - [x] azure_resources.go: Resource Group Contributor role (`AKS:RoleRG/s` / `AKS:RoleRG/efail`)
  - [x] azure_cr.go: ACR Pull role (`AKS:RoleCR/s` / `AKS:RoleCR/efail`)
  - [x] azure_dns.go: DNS Zone Contributor role (`AKS:RoleDNS/s` / `AKS:RoleDNS/efail`)
  - [x] azure_kv.go: Key Vault resource lookup (`AKS:EnsureKV/s` / `AKS:EnsureKV/efail`)
  - [x] azure_kv.go: Key Vault Secrets User role (`AKS:RoleKV/s` / `AKS:RoleKV/efail`)
- [x] 全変更のビルド確認。
- [x] 仕様書 [Kompox-Logging.ja.md] を作成・更新（Event/Span/Step パターン、ログレベルルール、サフィックス形式）。

## 受け入れ条件

- 対象コマンドを実行した際、`CMD:<operation>/S` が出力される。
- 成功時は `CMD:<operation>/EOK`、失敗時は `CMD:<operation>/EFAIL` が出力される。
- ログに `runId`, `resourceId`, `err`, `elapsed` 属性が適切に付与される。
- `runId` は開始と終了で同一。
- `elapsed` は開始からの経過秒数（数値）。
- Span/Step のログレベルはすべて `INFO` (機械的記録)。
- AKS ドライバーメソッドで `AKS:<method>/S`/`/EOK`/`/EFAIL` が出力される。
- Azure 操作で `AKS:<operation>/s` (開始)、`AKS:<operation>/efail` (失敗時) が出力される。
- アプリケーション判断は Event ログ（サフィックスなし）で `ERROR` 等の適切なレベルで記録される。

## 適用コマンド一覧

### CLI レイヤー（20コマンド）

1. **cluster** (4): provision, deprovision, install, uninstall
2. **app** (2): deploy, destroy
3. **box** (2): deploy, destroy
4. **disk** (2): create, delete
5. **dns** (2): deploy, destroy
6. **secret env** (2): set, delete
7. **secret pull** (2): set, delete
8. **snapshot** (2): create, delete

### ドライバーレイヤー（4メソッド）

1. **AKS driver**: ClusterProvision, ClusterDeprovision, ClusterInstall, ClusterUninstall

## サンプル出力

### CLI コマンド例（cluster provision 成功）

```
2025/10/26 10:15:23 INFO CMD:cluster.provision/S runId=k4x9p7 resourceId=ws1/prv1/cls1
2025/10/26 10:15:24 INFO AKS:ClusterProvision/S driver=AKS.ClusterProvision
2025/10/26 10:15:25 INFO AKS:EnsureRG/s subscription=sub1 location=eastus name=rg-cls1
2025/10/26 10:15:26 INFO AKS:RoleRG/s principalId=abc123 scope=/subscriptions/sub1/resourceGroups/rg-cls1
...
2025/10/26 10:16:09 INFO AKS:ClusterProvision/EOK driver=AKS.ClusterProvision err="" elapsed=45.2
2025/10/26 10:16:09 INFO CMD:cluster.provision/EOK runId=k4x9p7 resourceId=ws1/prv1/cls1 err="" elapsed=46.5
```

### CLI コマンド例（app deploy 失敗）

```
2025/10/26 10:20:15 INFO CMD:app.deploy/S runId=m2n8q3 resourceId=ws1/prv1/cls1/app1
2025/10/26 10:20:16 INFO AKS:ClusterProvision/S driver=AKS.ClusterProvision
2025/10/26 10:20:17 INFO AKS:EnsureRG/s subscription=sub1 location=eastus name=rg-cls1
2025/10/26 10:20:18 INFO AKS:EnsureRG/efail subscription=sub1 location=eastus name=rg-cls1 err="resource group not found: rg-foo"
2025/10/26 10:20:18 INFO AKS:ClusterProvision/EFAIL driver=AKS.ClusterProvision err="resource group not found: rg-foo" elapsed=2.1
2025/10/26 10:20:19 INFO CMD:app.deploy/EFAIL runId=m2n8q3 resourceId=ws1/prv1/cls1/app1 err="AKS operation failed: resourc..." elapsed=3.7
2025/10/26 10:20:19 ERROR CMD:app.deploy:Failed runId=m2n8q3 resourceId=ws1/prv1/cls1/app1 err="FAILED: AKS operation failed: resource group not found: rg-foo"
```

注: 最後の Event ログ (`CMD:app.deploy:Failed`) でアプリケーションとしての失敗判断を `ERROR` レベルで記録。

## メモ

- `runId` は `naming.NewCompactID()` を使用（短く、ログやトレースの相関キーとして扱う）。
- Named return value `(err error)` と `defer func() { cleanup(err) }()` パターンを活用。
- エラーメッセージは32文字で切り詰め（`...` 付加）。
- `elapsed` は数値（float seconds）として出力され、ログ分析ツールでの処理が容易。
- 変数名は `logger`（`enhancedLogger` から簡潔化）。

## 進捗

- 2025-10-24: タスク作成、初期実装完了
- 2025-10-26: Span パターンと Step パターンの適用完了
  - **Span パターン実装**:
    - メッセージフォーマット: `STARTED`/`SUCCESS`/`FAILURE` → `<operation>:START`/`END:OK`/`END:FAILED`
    - CLI レイヤー関数名: `withRunLogHeader` → `withCmdRunLogger`
    - ドライバーレイヤー: `withDriverLogHeader` 関数 → `(*driver).withMethodLogger` メソッド
    - 失敗時のログレベルを `WARN` に変更
    - 変数名を `logger` に簡潔化
  - **Step パターン実装**:
    - Azure 関連操作に適用（6箇所）
    - 操作名: `AKS:EnsureRG`, `AKS:RoleRG`, `AKS:RoleCR`, `AKS:RoleDNS`, `AKS:EnsureKV`, `AKS:RoleKV`
    - 冗長なログメッセージを削除し、操作名と失敗時のみの簡潔なログに統一
    - camelCase 属性名を使用: `principalId`, `scope`, `kvName`, `certName`, `name`, `subscription`, `location`, `tags`
  - 仕様書 [Kompox-Logging.ja.md] を作成・更新
- 2025-10-26: Event/Span/Step パターン仕様変更
  - **用語変更**: Trace → Event (分散トレースとの混同回避)
  - **サフィックス形式統一**: 
    - Span: `:START`/`:END:OK`/`:END:FAILED` → `/S`/`/EOK`/`/EFAIL`
    - Step: `:START`/`:END:OK`/`:END:FAILED` → `/s`/`/eok`/`/efail`
    - Event: サフィックスなし
  - **ログレベルルール明確化**:
    - Span/Step: `DEBUG` または `INFO` のみ (機械的記録)
    - Event: 任意のレベル (意味的判断による)
  - **grep 最適化**: `/E` で全 Span 終了、`/e` で全 Step 終了を一括検索可能
  - **エラーメッセージ処理**: 
    - Span/Step の `err` 属性: 32文字切り詰め
    - Event ログ: 完全なエラーメッセージを "FAILED:" プレフィックス付きで記録
  - 仕様書 [Kompox-Logging.ja.md] とタスクファイルを新仕様に更新

## 参考

- [Kompox-Logging.ja.md] - ロギング仕様書（Span/Step パターン定義）
- [cmd/kompoxops/logging.go] - CLI レイヤー実装
- [aks-logging.go] - AKS ドライバーレイヤー実装
- [kompoxops-cmd] - CLI コマンド実装
- [logging-pkg] - ロギングパッケージ
- [naming] - ID生成ユーティリティ

[Kompox-Logging.ja.md]: ../../design/v1/Kompox-Logging.ja.md
[cmd/kompoxops/logging.go]: ../../cmd/kompoxops/logging.go
[aks-logging.go]: ../../adapters/drivers/provider/aks/logging.go
[kompoxops-cmd]: ../../cmd/kompoxops
[logging-pkg]: ../../internal/logging
[naming]: ../../internal/naming
