---
id: 2025-10-07-aks-dns
title: AKS Driver - ClusterDNSApply 実装と DNS 権限付与
status: active
updated: 2025-10-08
language: ja
---
# Task: AKS Driver - ClusterDNSApply 実装と DNS 権限付与

## 目的

- AKS ドライバにおける `ClusterDNSApply()` の実装方針を固め、最小機能で動作可能にする。
- `kompoxops.yml` の `cluster.settings` に定義された更新許可 Azure DNS Zone リストに基づき、FQDN が属するゾーンへ A/AAAA/CNAME を適用/削除できる状態にする。
- `kompoxops cluster install` 実行タイミングで AKS Managed Identity へ DNS Zone Contributor ロールを付与し、書き込み権限を確保する。

## スコープ / 非スコープ

- In:
  - `adapters/drivers/provider/aks` 配下での DNS 適用ロジック（ゾーン解決、入力検証、Upsert/Delete、DryRun/Strict）。
  - `kompoxops.yml` の `cluster.settings.AZURE_AKS_DNS_ZONE_RESOURCE_IDS` から更新許可ゾーンを取得。
  - `kompoxops cluster install` (内部的には `ClusterInstall()`) 呼び出しフローで DNS Zone Contributor 付与を実行（ベストエフォート）。
  - 既存 Usecase/CLI (`dns deploy/destroy`) からの呼び出しで機能することの確認。
- Out:
  - 全レコード種別の完全対応（最初は A/AAAA/CNAME のみ）。
  - 自動 GC（孤児レコードの検出/削除）や差分同期。
  - すべてのクラウド/プロバイダ対応（AKS/Azure DNS のみ）。
  - `app.settings.AZURE_AKS_DNS_ZONE_RESOURCE_IDS` 対応（将来拡張）。

## 設計/仕様サマリ

- 設定
  - `cluster.settings.AZURE_AKS_DNS_ZONE_RESOURCE_IDS`: 更新可能な Azure DNS Zone のリソースID一覧（カンマ/スペース区切り）。
  - 例: `/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Network/dnszones/{zone}`
  - FQDN に対する最長一致で選択し、ZoneHint が指定されていればそちらを優先（ID/名前両対応）。
  
- 権限付与（DNS Zone Contributor）
  - 役割: DNS Zone Contributor (`roleDefIDDNSZoneContributor = befefa01-2a29-4197-83a8-272ff33ce314`).
  - 主体: AKS kubelet managed identity（deployment outputs の `outputAksPrincipalID`）。
  - タイミング: `kompoxops cluster install` 呼び出し時、Traefik インストール前（Step 4）に実行。
  - 実装方針: `ClusterInstall()` 内で、設定された全 Zone に冪等に付与（principalID が取得できない場合や失敗時は Warn ログ、ベストエフォート）。
  - 実装場所: `ensureAzureDNSZoneRoles()` は `azure_dns.go` に配置（DNS関連ロジックと同じファイル）。

- ClusterDNSApply 実装
  - 入力: `model.DNSRecordSet { FQDN, Type(A/AAAA/CNAME), TTL, RData }`。
  - ゾーン選択
    - 候補: `cluster.settings.AZURE_AKS_DNS_ZONE_RESOURCE_IDS` に定義されたゾーンのみ。
    - 選択ロジック: FQDN に対する最長一致。`ZoneHint` がある場合はヒントを優先（ID/名前両対応）。
    - 未決定時: 既定ベストエフォート（Warn ログで no-op）。Strict 指定時は error。
  - 入力検証と正規化
    - `TTL==0` は既定 300（`defaultDNSRecordTTL`）に正規化。
    - CNAME は RData が 1 件のみであることを検証。
    - Azure DNS のレコードセット名はゾーン相対（APEX は "@"）に変換。
  - レコード適用
    - `RData` が空の場合: Delete 操作。
    - `RData` が非空の場合: Upsert 操作（CreateOrUpdate）。
    - DryRun: 実行せずログ出力のみ。
  - リソースID解析
    - `arm.ParseResourceID()` を使用してゾーンリソースIDからサブスクリプション、リソースグループ、ゾーン名を抽出。
    - DNS APIクライアント作成時はゾーンリソースIDに含まれるサブスクリプションIDを使用（クロスサブスクリプション対応）。
  - エラーハンドリング
    - Strict: 失敗を error として呼び出し元に返す。
    - 既定（ベストエフォート）: Warn ログで継続。
  - ロギング
    - Upsert/Delete: `zone_resource_id`, `record_name`, `type`, `ttl`, `rdata` を出力。
    - DryRun: `action`, `cluster`, `zone`, `zone_id`, `fqdn`, `type`, `ttl`, `rdata`, `strict` を出力。
    - 権限付与: `dns_zone_name`, `dns_zone_resource_id`, `principal_id` を出力（成功/失敗で1行ずつ）。

## 計画（チェックリスト）

- [x] ClusterDNSApply 本体の実装（AKS/Azure DNS SDK 組込み）
  - [x] ゾーンID収集（cluster.settings.AZURE_AKS_DNS_ZONE_RESOURCE_IDS）。
  - [x] ゾーンIDパースと最長一致選択、ZoneHint 優先（`arm.ParseResourceID` 使用）。
  - [x] 入力検証と正規化（FQDN/Type/TTL/RData）。
  - [x] DryRun 出力。
  - [x] A/AAAA/CNAME の Upsert/Delete 実装（CreateOrUpdate/Delete、クロスサブスクリプション対応）。

- [x] 権限付与ヘルパーの追加と呼び出し点の接続
  - [x] `ensureAzureDNSZoneRoles(ctx, principalID, zones)` を `azure_dns.go` に追加（冪等付与）。
  - [x] `ClusterInstall()` の Step 4 として DNS Zone Contributor 付与を実行（Traefik インストール前）。
  - [x] principalID が取得できない場合や権限付与失敗時は Warn ログで継続（ベストエフォート）。

- [x] コードリファクタリング
  - [x] `azureDNSZoneInfo` 構造体から `ResourceGroup` フィールドを削除（必要時に `arm.ParseResourceID` で抽出）。
  - [x] ログ出力を改善（`zone_resource_id` に統一、`zone`/`zone_rg` を削除）。
  - [x] 設定キー名を `AZURE_AKS_DNS_ZONE_RESOURCE_IDS` に変更し定数化（`settingAzureAKSDNSZoneResourceIDs`）。
  - [x] ロール定義IDを定数化（`roleDefIDDNSZoneContributor`）、ヘルパーメソッド `azureRoleDefinitionID()` を追加。
  - [x] TTLデフォルト値を定数化（`defaultDNSRecordTTL = 300`）。

- [x] ユニットテスト
  - [x] ゾーン解決（最長一致/HINT 優先）のテスト。
  - [x] CNAME 入力検証（RData=1件）のテスト。
  - [x] 相対名/"@" 変換のテスト。
  - [x] `arm.ParseResourceID` を使用したリソースID解析のテスト。

- [x] E2Eテスト
  - [x] `kompoxops.yml.in` および `test.env` に AZURE_AKS_DNS_ZONE_RESOURCE_IDS を追加。

- [ ] ドキュメント
  - [ ] `kompoxops.yml` 例（AZURE_AKS_DNS_ZONE_RESOURCE_IDS 設定例）を README に追記。

## テスト

- ユニット
  - ゾーンIDパースと最長一致の境界ケース（サブゾーン優先、ドット終端の扱い）。
  - CNAME の RData 件数の検証。
  - `TTL==0` の正規化（300）。
  - 相対名変換と "@" の扱い。

- スモーク/E2E
  - 実 AKS + Azure DNS 環境で `kompoxops dns deploy --dry-run` のログ確認。
  - 権限がない状態でも既定（非 Strict）で失敗しないこと。
  - `--strict` で書き込み失敗がエラー化されること。
  - `kompoxops cluster install` 実行後、AKS MI に DNS Zone Contributor が付与されていること。

## 受け入れ条件

- `kompoxops cluster install` 実行時に、`cluster.settings.AZURE_AKS_DNS_ZONE_RESOURCE_IDS` に定義された全ゾーンに対して DNS Zone Contributor ロールが付与される（ベストエフォート、Traefik インストール前に実行）。
- Usecase/CLI から `ClusterDNSApply()` が呼ばれ、DryRun/Strict の挙動が一貫する。
- 設定されたゾーンに属する FQDN のみが対象となる（最長一致 & ヒント優先）。
- A/AAAA/CNAME の Upsert/Delete が動作する（少なくとも 1 ケースは実環境で確認）。
- 権限付与失敗時も既定では警告で継続し、処理が中断されない。
- クロスサブスクリプションのDNSゾーンに対応（ゾーンリソースIDから抽出したサブスクリプションIDを使用）。

## メモ

- 役割付与は既存の `ensureAzureRole(scope, principalID, roleDefinitionId)` の再利用で実装。
- ロール定義IDは `azure_roles.go` に定数として定義（`roleDefIDDNSZoneContributor`）。
- ヘルパーメソッド `azureRoleDefinitionID()` でサブスクリプションスコープの完全なロール定義IDを構築。
- 既存の `2025-10-01-cluster-dns` タスクの仕様と整合させること（Usecase/CLI 側の Strict/DryRun ポリシー）。
- リソースID解析には Azure SDK の `arm.ParseResourceID` を使用（`volume_snapshot.go` と同じパターン）。
- `azureDNSZoneInfo` 構造体は `ResourceID` と `Name` のみを保持（`ResourceGroup` は削除、必要時に動的に解析）。
- SOAレコードのシリアル番号は Azure DNS が自動的に管理するため、手動更新は不要。
- 設定キー名は `AZURE_AKS_DNS_ZONE_RESOURCE_IDS` で、定数名は `settingAzureAKSDNSZoneResourceIDs`。
- 将来拡張: TXT/CAA/SRV/MX 等の対応は別タスクで。変更衝突や ETag 管理が必要になれば段階導入。
- `app.settings.AZURE_AKS_DNS_ZONE_RESOURCE_IDS` の対応は今回スコープ外（将来的に和集合で集約する設計）。

## 進捗

- 2025-10-07: タスク起票（仕様固め、実装項目の洗い出し）。
- 2025-10-07: 実装完了（要点）。
  - Azure DNS 連携の中核実装を完了（`azure_dns.go` 追加、`ClusterDNSApply()` 統合、`ClusterInstall()` に権限付与を組込み）。
  - A/AAAA/CNAME の Upsert/Delete、DryRun/Strict、クロスサブスクリプション対応を実装し、ユニットテストを追加。
  - ビルドと基本的な E2E を通過（`cluster install`/`dns deploy`/`app deploy --update-dns`）。
- 2025-10-08: 設定と E2E の横展開。
  - すべての E2E テストフォルダに DNS ゾーン設定と証明書設定を展開（`AZURE_AKS_DNS_ZONE_RESOURCE_IDS`/`cluster.ingress.certificates`）。
  - `test-run.sh` に `--update-dns` を追加、`test-teardown.sh` に `dns destroy` を導入（volume シナリオを除く）。
  - 各テストの設定整備と一貫性確認を実施。

## 参考

- タスク
  - [2025-10-01-cluster-dns.ja.md](./2025-10-01-cluster-dns.ja.md)
- 設計
  - [Kompox-Arch-Implementation.ja.md](../../design/v1/Kompox-Arch-Implementation.ja.md)
- ADR
  - [K4x-ADR-004](../../design/adr/K4x-ADR-004.md)
