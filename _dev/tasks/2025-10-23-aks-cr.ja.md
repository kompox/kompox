---
id: 2025-10-23-aks-cr
title: AKS Driver - ACR 権限付与対応
status: active
updated: 2025-10-23
language: ja
owner: yaegashi
---
# Task: AKS Driver - ACR 権限付与対応

## 目的

- 先行実装の DNS 権限付与パターンを踏襲し、AKS の kubelet managed identity に対して Azure Container Registry(ACR) の AcrPull ロールを付与できるようにする。
- model.Cluster の Settings に `AZURE_AKS_CONTAINER_REGISTRY_RESOURCE_IDS` を受け付け、列挙された ACR に対しロール付与を行う。
- `kompoxops cluster install` 実行時の Step 5 として、DNS Zone Contributor 付与の後に ACR AcrPull 付与をベストエフォートで実行する。

## スコープ / 非スコープ

- In:
  - `model.Cluster.Settings["AZURE_AKS_CONTAINER_REGISTRY_RESOURCE_IDS"]` を解釈(カンマ/スペース区切りの Resource ID)。
  - `adapters/drivers/provider/aks/azure_cr.go` の新設:
    - `collectAzureContainerRegistryIDs()`
    - `ensureAzureContainerRegistryRoles()`
  - `adapters/drivers/provider/aks/cluster.go` `ClusterInstall()` に ACR 付与処理を追加(Step 5、DNS の直後)。
  - 役割定義 ID の定数化(AcrPull: `7f951dda-4ed3-4680-a7ca-43fe172d538d`)。
- Out:
  - ACR の作成やネットワーク(Private Link, Firewall)構成の自動化。
  - Cross-tenant のサポート(本タスクではスコープ外、別途検討)。
  - App と Cluster の複合スコープ結合やマージロジックの導入(今回は Cluster 側の設定のみ)。

## 仕様サマリ

- 設定キー
  - `AZURE_AKS_CONTAINER_REGISTRY_RESOURCE_IDS`: ACR の Resource ID のリストをカンマ/スペース区切りで指定。
  - 対象は `model.Cluster.Settings`。必要最低限の責務として Cluster 単位での宣言型指定に限定。
- リソース ID 形式
  - 期待値: `/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.ContainerRegistry/registries/{name}`。
  - 解析は `arm.ParseResourceID()` を使用。
- 付与先主体
  - AKS kubelet managed identity(deployment outputs の `outputAksPrincipalID` を利用)。
- 付与ロール
  - AcrPull (`roleDefIDAcrPull = 7f951dda-4ed3-4680-a7ca-43fe172d538d`)。
- 実行タイミングと順序
  - `kompoxops cluster install` の Step 5 で DNS Zone Contributor 付与の直後に実施。
- エラーポリシーとログ
  - ベストエフォート: principalId 未取得や付与失敗は警告ログで継続。
  - ログには `registry`, `registry_resource_id`, `principal_id` を含める。
- クロスサブスクリプション
  - スコープは ACR リソース単位のため、リソース ID に基づく付与で cross-subscription を許可。

## 計画 (チェックリスト)

- [ ] 役割定義 ID を `azure_roles.go` に追加(`roleDefIDAcrPull`)。
- [ ] `adapters/drivers/provider/aks/azure_cr.go` を追加:
  - [ ] `collectAzureContainerRegistryIDs()` 実装(Cluster.Settings からの収集、ID 解析)。
  - [ ] `ensureAzureContainerRegistryRoles()` 実装(AcrPull の冪等付与、ベストエフォート)。
- [ ] `adapters/drivers/provider/aks/cluster.go` を更新:
  - [ ] DNS 付与の直後に ACR 付与を実行(Step 5 として追加)。
- [ ] ユニットテスト:
  - [ ] Resource ID パース(不正/正規、複数区切り)。
  - [ ] ロール付与呼び出しの冪等性とログ出力の検証。
- [ ] ドキュメント/索引:
  - [ ] 本タスクを `_dev/tasks/README*.md` の索引に反映(`make gen-index`)。

## テスト

- ユニット
  - ACR Resource ID パースの境界ケース(空、Provider/type 不一致、name 欠落、複数区切り)。
  - 付与ヘルパーのエラー時ベストエフォート継続の検証(モック)。
- スモーク/E2E
  - 既存 AKS クラスターに対して `kompoxops cluster install` を実行し、AKS MI に対して各 ACR の AcrPull が付与されることを確認。
  - 失敗ケースでもインストールが継続し、警告ログが出力されること。

## 受け入れ条件

- `model.Cluster.Settings["AZURE_AKS_CONTAINER_REGISTRY_RESOURCE_IDS"]` に列挙された全 ACR に対して、`kompoxops cluster install` 実行時に AKS MI へ AcrPull が付与される(DNS 付与の直後に Step 5 で実施、ベストエフォート)。
- クロスサブスクリプションの ACR に対しても、指定された Resource ID を用いた付与が可能。
- ログが付与対象と結果を明確に示す(成功/失敗、対象 registry 名と resource ID)。
- 既存の DNS 付与フローと整合する(順序、ベストエフォート、警告運用)。

## メモ

- 後方互換性は不要。
- Cross-tenant は本タスクの対象外。必要に応じて別タスクで設計/検証を行う。
- 既存の `ensureAzureRole(scope, principalID, roleDefinitionId)` を再利用し、スコープは各 registry の ResourceID を指定する。
- 設定は Cluster 単位から開始し、将来の統合(App/Cluster マージやプロバイダ横断のポリシー)は別タスクで扱う。

## 進捗

- 2025-10-23: タスク起票(仕様固め、実装項目の洗い出し)。

## 参考

- 先行タスク
  - [2025-10-07-aks-dns.ja.md]
- 設計
  - [Kompox-Arch-Implementation.ja.md]
- ADR
  - [K4x-ADR-004]

[2025-10-07-aks-dns.ja.md]: ./2025-10-07-aks-dns.ja.md
[Kompox-Arch-Implementation.ja.md]: ../../design/v1/Kompox-Arch-Implementation.ja.md
[K4x-ADR-004]: ../../design/adr/K4x-ADR-004.md