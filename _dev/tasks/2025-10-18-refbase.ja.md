---
id: 2025-10-18-refbase
title: App.RefBase の導入と参照解決の一元化
status: active
updated: 2025-10-19
language: ja
owner: yaegashi
---

# Task: App.RefBase の導入と参照解決の一元化

## 目的

- 由来(Kompox アプリファイル直下/外部KOM/URL)に基づく許可・禁止を一箇所で制御する。
- 文字列スキャンによるローカルファイルシステム参照検出を廃止し、構造化後の妥当性検証に置き換える。
- セキュリティ上の意図しないローカルアクセスを防止する。
- 参照: [K4x-ADR-012]

## スコープ / 非スコープ

- In:
  - domain: `App.RefBase` 追加
  - v1alpha1: `file:compose.yml` 展開の削除、`RefBase` 設定
  - kompoxopscfg: `file:compose.yml` 展開の削除、`RefBase` 設定(kompoxops 設定経由のローダも v1alpha1 と同一ポリシー)
  - kube: Compose/env_file/configs/secrets の参照解決を `RefBase` 起点に変更、ポリシー検証の実装
  - CLI: 旧 `HasLocalFSReference` 呼び出しの削除
  - テスト: 上記に対応した追加/調整
- Out:
  - 既存の永続化スキーマ移行の詳細(必要に応じて別タスク)
  - URL 起点の fetch キャッシュや認証付き取得(将来検討)

## 仕様サマリ

- `App.RefBase` の意味と責務分担
  - `""`(空): 外部参照禁止
  - `file:///abs/dir/`: ローカル参照許可(相対はこのディレクトリ基点)
  - `http(s)://.../`: 相対URL解決のみ許可(ローカル参照は不可)
- KOM ローダーによる `App.RefBase` の設定
  - Kompox アプリファイルに含まれる App の場合のみ、そのディレクトリパスを `file:///abs/dir/` に正規化して設定。
  - それ以外の場所の App では空文字列を設定。
- 外部参照ポリシーの検証タイミング
  - KOM ローダーでは外部参照ポリシー違反は検証せず通過する。実行時に kube Converter で検証・エラー報告する

## 計画(チェックリスト)

- [x] 設計ドキュメント更新: ローカルファイルシステム参照ポリシーと検証タイミング(読み込み時は通過、実行時に検証)を反映する。
  - [x] [Kompox-CLI.ja.md]
  - [x] [Kompox-KOM.ja.md]
- [x] domain: `App` に `RefBase` を追加する(コメントで意味を明文化)[domain model App]
- [x] v1alpha1: `processCompose` から `file:` 展開を削除する[v1alpha1 loader and sink]
  - [x] Kompox アプリファイル直下の App に `RefBase=file://<dir>/` を設定
  - [x] 外部KOM由来の App は `RefBase=""` を設定
- [x] kompoxopscfg: コンバータで `file:compose.yml` 展開を停止し `RefBase` を設定する[kompoxopscfg converter]
  - [x] kompoxops 設定ファイルの配置ディレクトリを基点に `file://` を設定(該当時)
  - [x] 外部由来でのローカル参照はエラーにする(将来の kube.converter で実装)
- [x] kube.compose: `NewComposeProject` を `RefBase` 対応に実装[kube compose loader]
  - [x] refBase 検証: url.Parse による URL 構造検証(空または file/http/https スキーム付き URL)
  - [x] composeContent 検証: file:relative/path のみ許可(絶対パス・親ディレクトリ参照・http/https URL を拒否)
  - [x] WorkingDir 分離: compose-go には "." を渡し、実際の workingDir は別途返却
- [x] kube.converter: 構造化後バリデーションを実装[kube converter]
  - [x] `RefBase` が `file://` 以外のとき、host bind・env_file・configs/secrets(file) を拒否
  - [x] named volume は常に許可
- [x] CLI: 旧 `HasLocalFSReference` の呼び出しを削除[CLI loader]
- [ ] テスト: 許可/不許可の境界テストを追加[tests]
  - [x] 既存テスト全更新: model.App に RefBase = "file://" + dir + "/" 設定
  - [ ] Kompox アプリ直下(file://)での成功ケース
  - [ ] 外部KOM(空)での拒否ケース
  - [ ] URL 起点(http)での相対URL成功・ローカル拒否
- [ ] ドキュメント: ADR 参照追記、索引再生成(`make gen-index`)[adr.readme]

## テスト

- ユニット: kube のリーダ/バリデータ(compose/env_file/configs/secrets/volumes)を `RefBase` の各状態で検証。
- スモーク: `kompoxops app validate` で Kompox アプリ直下と外部KOMの差異が反映されること(読み込み成功後、コマンド実行時に検証エラーが発生する)。

## 受け入れ条件

- Kompox アプリファイル直下の App に対しては、ローカル参照が機能する(`RefBase = file://.../`)。
- 外部KOM由来の App でローカル参照を用いた場合、明確なエラーで失敗する(`RefBase = ""`)。
- URL 起点では相対URL解決は可能だが、ローカル参照は拒否される(`RefBase = http(s)://.../`)。
- 既存テストが緑で、新規テストが全て通る。
 - KOM の読み込みは失敗させず成功し、`kompoxops app ...` 実行時に `RefBase` に基づくポリシー違反がエラーとして報告される。

## メモ

- 後方互換性は不要(ADR に明記)。
- 変更が広範なため、段階的に PR を分割する(domain → v1alpha1 → kube → CLI → tests)。

## 進捗

- 2025-10-18: ADR 受理(accepted)。本タスク作成。
- 2025-10-18: domain.App に RefBase フィールドを追加([K4x-ADR-012] 準拠のコメント付き)。
- 2025-10-18: v1alpha1.Sink.ToModels を更新:
  - kompoxAppFilePath パラメータを追加
  - processCompose による file: 展開を削除
  - RefBase を設定(Kompox app file 直下: file://<dir>/、外部KOM: 空)
  - 関連テストを更新
- 2025-10-18: kompoxopscfg.Root.ToModels を更新:
  - configFilePath パラメータを追加
  - processCompose を composeToString に変更(file: 読み込み削除)
  - RefBase を設定(file://<config-dir>/)
  - 関連テストと Store.LoadFromConfig を更新
- 2025-10-18: CLI の kom_loader と repos_builder を更新:
  - komModeContext に kompoxAppFilePath を追加
  - 全ての ToModels/LoadFromConfig 呼び出しでファイルパスを渡すように更新
  - ビルドとテストが全て成功
- 2025-10-18: kube adapter を更新(RefBase ベースの参照解決とバリデーション):
  - kube.compose: NewComposeProjectWithRefBase 実装
  - HTTP fetch 対応(http(s):// RefBase 時)
  - file: 読み込み(file:// RefBase のみ許可)
    - readFileContent と resolveConfigOrSecretFile で RefBase バリデーション
  - kube.converter: Convert メソッドで NewComposeProjectWithRefBase を使用
  - WorkingDir フィールド追加(RefBase から抽出)
  - bind volume バリデーション(file:// RefBase 必須、ディレクトリチェック)
  - configs/secrets バリデーション(file:// RefBase 必須)
  - kube.compose_content: mergeEnvFiles RefBase バリデーション
  - テスト全更新(model.App に RefBase = "file://" + dir + "/" 設定)
  - 全ての kube adapter テストと全体テストが成功
- 2025-10-19: kube.compose を更新(仕様の精緻化):
  - NewComposeProjectWithRefBase を NewComposeProject に改名
  - refBase 検証を url.Parse ベースに変更(strings チェックを削除)
  - composeContent を file: prefix のみに制限(http/https URL を拒否)
  - file: 参照を相対パスのみに制限(絶対パス・親ディレクトリ参照を拒否)
  - WorkingDir 分離設計: compose-go には "." を渡し、実際の workingDir は別途返却
  - 全テスト成功
- 2025-10-19: 設計ドキュメント更新:
  - Kompox-CLI.ja.md: composeContent 形式制約を明記(file:relative/path のみ、絶対パス・親ディレクトリ参照・http/https URL 不可)
  - Kompox-KOM.ja.md: ローダーは Compose を文字列として保持(解釈しない)ことを明記
- 2025-10-19: CLI の HasLocalFSReference 呼び出しを削除:
  - kom_loader.go: KOM ロード時の HasLocalFSReference チェックを削除([K4x-ADR-012] に従い、検証は実行時に kube.Converter で実施)
  - app_validation.go: HasLocalFSReference 関数を含むファイル全体を削除
  - kom_loader_test.go: TestInitializeKOMMode_LocalFSReferenceValidation テストを削除
  - 全テスト成功

## 参考

- [K4x-ADR-012]
- [Kompox-CLI.ja.md]
- [Kompox-KOM.ja.md]
- [2025-10-17-defaults.ja.md]
- [v1alpha1 loader and sink]
- [kompoxopscfg converter]
- [kube compose loader]
- [kube converter]
- [domain model App]

[K4x-ADR-012]: ../../design/adr/K4x-ADR-012.md
[Kompox-CLI.ja.md]: ../../design/v1/Kompox-CLI.ja.md
[Kompox-KOM.ja.md]: ../../design/v1/Kompox-KOM.ja.md
[2025-10-17-defaults.ja.md]: ./2025-10-17-defaults.ja.md
[v1alpha1 loader and sink]: ../../config/crd/ops/v1alpha1/sink_tomodels.go
[kompoxopscfg converter]: ../../config/kompoxopscfg/converter.go
[kube compose loader]: ../../adapters/kube/compose.go
[kube converter]: ../../adapters/kube/converter.go
[domain model App]: ../../domain/model/app.go
[adr.readme]: ../../design/adr/README.md
[CLI loader]: ../../cmd/kompoxops/kom_loader.go
[tests]: ../../tests/
