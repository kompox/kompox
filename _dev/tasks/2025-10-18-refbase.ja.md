---
id: 2025-10-18-refbase
title: App.RefBase の導入と参照解決の一元化
status: active
updated: 2025-10-18
language: ja
owner: yaegashi
---

# Task: App.RefBase の導入と参照解決の一元化

## 目的

- 由来（Kompox アプリファイル直下/外部KOM/URL）に基づく許可・禁止を一箇所で制御する。
- 文字列スキャンのローカルFS検出を廃止し、構造化後の妥当性検証に置き換える。
- セキュリティ上の意図しないローカルアクセスを防止する。

## スコープ / 非スコープ

- In:
  - domain: `App.RefBase` 追加
  - v1alpha1: `file:compose.yml` 展開の削除、`RefBase` 設定
  - kompoxopscfg: `file:compose.yml` 展開の削除、`RefBase` 設定（kompoxops 設定経由のローダも v1alpha1 と同一ポリシー）
  - kube: Compose/env_file/configs/secrets の参照解決を `RefBase` 起点に変更、ポリシー検証の実装
  - CLI: 旧 `HasLocalFSReference` 呼び出しの削除
  - テスト: 上記に対応した追加/調整
- Out:
  - 既存の永続化スキーマ移行の詳細（必要に応じて別タスク）
  - URL 起点の fetch キャッシュや認証付き取得（将来検討）

## 仕様サマリ

- `RefBase` の意味と責務分担は ADR に準拠。[K4x-ADR-012]
  - `""`（空）: 外部参照禁止
  - `file:///abs/dir/`: ローカル参照許可（相対はこのディレクトリ基点）
  - `http(s)://.../`: 相対URL解決のみ許可（ローカル参照は不可）
  - 検証タイミング: KOM の読み込みは失敗させず通過し、`kompoxops app ...` 実行時に kube Converter で検証・エラー報告する。

## 計画（チェックリスト）

- [ ] 設計ドキュメント更新: ローカルファイルシステム参照ポリシーと検証タイミング(読み込み時は通過、`kompoxops app` 実行時に検証)を反映する。[Kompox-CLI.ja.md]
- [ ] domain: `App` に `RefBase` を追加する（コメントで意味を明文化）[domain model App]
- [ ] v1alpha1: `processCompose` から `file:` 展開を削除する[v1alpha1 loader and sink]
  - [ ] Kompox アプリファイル直下の App に `RefBase=file://<dir>/` を設定
  - [ ] 外部KOM由来の App は `RefBase=""` を設定
- [ ] kompoxopscfg: コンバータで `file:compose.yml` 展開を停止し `RefBase` を設定する[kompoxopscfg converter]
  - [ ] kompoxops 設定ファイルの配置ディレクトリを基点に `file://` を設定（該当時）
  - [ ] 外部由来でのローカル参照はエラーにする
- [ ] kube.compose: `NewComposeProject` 相当を `RefBase` 対応に拡張（inline/file/url）[kube compose loader]
  - [ ] `file:` 読み込みは `RefBase` が `file://` の場合のみ許可
  - [ ] `http(s)` 相対URLは `RefBase` から解決（絶対URLはそのまま）
- [ ] kube.converter: 構造化後バリデーションを実装[kube converter]
  - [ ] `RefBase` が `file://` 以外のとき、host bind・env_file・configs/secrets(file) を拒否
  - [ ] named volume は常に許可
- [ ] CLI: 旧 `HasLocalFSReference` の呼び出しを削除[CLI loader]
- [ ] テスト: 許可/不許可の境界テストを追加[tests]
  - [ ] Kompox アプリ直下（file://）での成功ケース
  - [ ] 外部KOM（空）での拒否ケース
  - [ ] URL 起点（http）での相対URL成功・ローカル拒否
- [ ] ドキュメント: ADR 参照追記、索引再生成（`make gen-index`）[adr.readme]

## テスト

- ユニット: kube のリーダ/バリデータ（compose/env_file/configs/secrets/volumes）を `RefBase` の各状態で検証。
- スモーク: `kompoxops app validate` で Kompox アプリ直下と外部KOMの差異が反映されること（読み込み成功後、コマンド実行時に検証エラーが発生する）。

## 受け入れ条件

- Kompox アプリファイル直下の App に対しては、ローカル参照が機能する（`RefBase = file://.../`）。
- 外部KOM由来の App でローカル参照を用いた場合、明確なエラーで失敗する（`RefBase = ""`）。
- URL 起点では相対URL解決は可能だが、ローカル参照は拒否される（`RefBase = http(s)://.../`）。
- 既存テストが緑で、新規テストが全て通る。
 - KOM の読み込みは失敗させず成功し、`kompoxops app ...` 実行時に `RefBase` に基づくポリシー違反がエラーとして報告される。

## メモ

- 後方互換性は不要（ADR に明記）。
- 変更が広範なため、段階的に PR を分割する（domain → v1alpha1 → kube → CLI → tests）。

## 進捗

- 2025-10-19: ADR 受理（accepted）。本タスク作成。

## 参考

- [K4x-ADR-012]
- [Kompox-CLI.ja.md]
- [2025-10-17-defaults.ja.md]
- [v1alpha1 loader and sink]
- [kompoxopscfg converter]
- [kube compose loader]
- [kube converter]
- [domain model App]

[K4x-ADR-012]: ../../design/adr/K4x-ADR-012.md
[Kompox-CLI.ja.md]: ../../design/v1/Kompox-CLI.ja.md
[2025-10-17-defaults.ja.md]: ./2025-10-17-defaults.ja.md
[v1alpha1 loader and sink]: ../../config/crd/ops/v1alpha1/sink_tomodels.go
[kompoxopscfg converter]: ../../config/kompoxopscfg/converter.go
[kube compose loader]: ../../adapters/kube/compose.go
[kube converter]: ../../adapters/kube/converter.go
[domain model App]: ../../domain/model/app.go
[adr.readme]: ../../design/adr/README.md
[CLI loader]: ../../cmd/kompoxops/kom_loader.go
[tests]: ../../tests/
