---
id: 2025-10-24-log
title: kompoxops ログ標準化（Span パターン適用）
status: active
updated: 2025-10-26
language: ja
owner:
---
# Task: kompoxops ログ標準化（Span パターン適用）

## 目的

- kompoxops の CLI ログ出力を標準化し、Span パターンを適用する。
- 各操作の開始・終了を明確に記録し、エラーや経過時間を追跡可能にする。
- ログに一貫性のある属性（runId, resourceId など）を付与し、可観測性を向上させる。
- CLI レイヤーと AKS ドライバーレイヤーに統一されたロギングパターンを導入する。

詳細な仕様は [Kompox-Logging.ja.md] を参照。

## スコープ / 非スコープ

- In:
  - 全操作系コマンドの実行開始時に START ログを出力。
  - 成功/失敗時に END:OK/END:FAILED ログを出力。
  - ロガーに `runId`, `resourceId` などを属性として付与したコンテキストを下位層へ伝搬。
  - CLI レイヤー（20コマンド）と AKS ドライバーレイヤー（4メソッド）に適用。
- Out:
  - 全レイヤーへの完全適用（現時点で主要な操作コマンドとドライバーをカバー）。
  - ログ基盤/依存パッケージの入れ替えや大規模改修。
  - ドメイン層 API 仕様の変更。

## 仕様サマリ

### Span パターン

長時間実行される操作の開始・終了を記録するパターン。

- **開始**: `[<prefix>:]<operation>:START`
- **成功終了**: `[<prefix>:]<operation>:END:OK`
- **失敗終了**: `[<prefix>:]<operation>:END:FAILED`

詳細は [Kompox-Logging.ja.md] の「Span パターン」セクションを参照。

### CLI レイヤー（cmd/kompoxops）

- メッセージフォーマット:
  - 開始: `CMD:<operation>:START`
  - 終了: `CMD:<operation>:END:OK` または `CMD:<operation>:END:FAILED`
- 属性:
  - 開始時: `runId`, `resourceId`
  - 終了時: 上記 + `err`, `elapsed`
- 実装: `withCmdRunLogger` 関数（[cmd/kompoxops/logging.go]）

### ドライバーレイヤー（adapters/drivers/provider/aks）

- メッセージフォーマット:
  - 開始: `AKS:<method>:START`
  - 終了: `AKS:<method>:END:OK` または `AKS:<method>:END:FAILED`
- 属性:
  - `driver` (AKS.<method>), `err`, `elapsed`
- 実装: `(*driver).withMethodLogger` メソッド（[aks-logging.go]）

## 計画 (チェックリスト)

- [x] CLI 共通ヘルパ `withCmdRunLogger` を実装（`cmd/kompoxops/logging.go`）。
- [x] 20 CLI コマンドに適用:
  - [x] cluster (4): provision, deprovision, install, uninstall
  - [x] app (2): deploy, destroy
  - [x] box (2): deploy, destroy
  - [x] disk (2): create, delete
  - [x] dns (2): deploy, destroy
  - [x] secret env (2): set, delete
  - [x] secret pull (2): set, delete
  - [x] snapshot (2): create, delete
- [x] AKS ドライバーメソッド `withMethodLogger` を実装（`adapters/drivers/provider/aks/logging.go`）。
- [x] AKS 4メソッドに適用: ClusterProvision, ClusterDeprovision, ClusterInstall, ClusterUninstall
- [x] Step パターンを Azure role assignment 操作に適用（6箇所）:
  - [x] azure_resources.go: Resource Group 作成 (`AKS:EnsureRG` / `AKS:EnsureRG:FAILED`)
  - [x] azure_resources.go: Resource Group Contributor role (`AKS:RoleRG` / `AKS:RoleRG:FAILED`)
  - [x] azure_cr.go: ACR Pull role (`AKS:RoleCR` / `AKS:RoleCR:FAILED`)
  - [x] azure_dns.go: DNS Zone Contributor role (`AKS:RoleDNS` / `AKS:RoleDNS:FAILED`)
  - [x] azure_kv.go: Key Vault resource lookup (`AKS:EnsureKV` / `AKS:EnsureKV:FAILED`)
  - [x] azure_kv.go: Key Vault Secrets User role (`AKS:RoleKV` / `AKS:RoleKV:FAILED`)
- [x] 全変更のビルド確認。
- [x] 仕様書 [Kompox-Logging.ja.md] を作成・更新。

## 受け入れ条件

- 対象コマンドを実行した際、`CMD:<operation>:START` が出力される。
- 成功時は `CMD:<operation>:END:OK`、失敗時は `CMD:<operation>:END:FAILED` が出力される。
- ログに `runId`, `resourceId`, `err`, `elapsed` 属性が適切に付与される。
- `runId` は開始と終了で同一。
- `elapsed` は開始からの経過秒数（数値）。
- 失敗時のログレベルは `WARN`。
- AKS ドライバーメソッドで `AKS:<method>:START/END:OK/END:FAILED` が出力される。

## 適用コマンド一覧

### CLI レイヤー（20コマンド）

1. **cluster** (4): provision, deprovision, install, uninstall
2. **app** (2): deploy, destroy
3. **box** (2): deploy, destroy
4. **disk** (2): create, delete
5. **dns** (2): deploy, destroy
6. **secret env** (2): set, delete
7. **secret pull** (2): set, delete
8. **snapshot** (2): create, delete

### ドライバーレイヤー（4メソッド）

1. **AKS driver**: ClusterProvision, ClusterDeprovision, ClusterInstall, ClusterUninstall

## サンプル出力

### CLI コマンド例（cluster provision）

```
2025/10/26 10:15:23 INFO CMD:cluster.provision:START runId=k4x9p7 resourceId=ws1/prv1/cls1
2025/10/26 10:15:24 INFO AKS:ClusterProvision:START driver=AKS.ClusterProvision
...
2025/10/26 10:16:09 INFO AKS:ClusterProvision:END:OK driver=AKS.ClusterProvision err= elapsed=45.2
2025/10/26 10:16:09 INFO CMD:cluster.provision:END:OK runId=k4x9p7 resourceId=ws1/prv1/cls1 err= elapsed=46.5
```

### CLI コマンド例（app deploy 失敗）

```
2025/10/26 10:20:15 INFO CMD:app.deploy:START runId=m2n8q3 resourceId=ws1/prv1/cls1/app1
...
2025/10/26 10:20:19 WARN CMD:app.deploy:END:FAILED runId=m2n8q3 resourceId=ws1/prv1/cls1/app1 err="manifest validation failed: ..." elapsed=3.7
```

## メモ

- `runId` は `naming.NewCompactID()` を使用（短く、ログやトレースの相関キーとして扱う）。
- Named return value `(err error)` と `defer func() { cleanup(err) }()` パターンを活用。
- エラーメッセージは32文字で切り詰め（`...` 付加）。
- `elapsed` は数値（float seconds）として出力され、ログ分析ツールでの処理が容易。
- 変数名は `logger`（`enhancedLogger` から簡潔化）。

## 進捗

- 2025-10-24: タスク作成、初期実装完了
- 2025-10-26: Span パターンと Step パターンの適用完了
  - **Span パターン実装**:
    - メッセージフォーマット: `STARTED`/`SUCCESS`/`FAILURE` → `<operation>:START`/`END:OK`/`END:FAILED`
    - CLI レイヤー関数名: `withRunLogHeader` → `withCmdRunLogger`
    - ドライバーレイヤー: `withDriverLogHeader` 関数 → `(*driver).withMethodLogger` メソッド
    - 失敗時のログレベルを `WARN` に変更
    - 変数名を `logger` に簡潔化
  - **Step パターン実装**:
    - Azure 関連操作に適用（6箇所）
    - 操作名: `AKS:EnsureRG`, `AKS:RoleRG`, `AKS:RoleCR`, `AKS:RoleDNS`, `AKS:EnsureKV`, `AKS:RoleKV`
    - 冗長なログメッセージを削除し、操作名と失敗時のみの簡潔なログに統一
    - camelCase 属性名を使用: `principalId`, `scope`, `kvName`, `certName`, `name`, `subscription`, `location`, `tags`
  - 仕様書 [Kompox-Logging.ja.md] を作成・更新

## 参考

- [Kompox-Logging.ja.md] - ロギング仕様書（Span/Step パターン定義）
- [cmd/kompoxops/logging.go] - CLI レイヤー実装
- [aks-logging.go] - AKS ドライバーレイヤー実装
- [kompoxops-cmd] - CLI コマンド実装
- [logging-pkg] - ロギングパッケージ
- [naming] - ID生成ユーティリティ

[Kompox-Logging.ja.md]: ../../design/v1/Kompox-Logging.ja.md
[cmd/kompoxops/logging.go]: ../../cmd/kompoxops/logging.go
[aks-logging.go]: ../../adapters/drivers/provider/aks/logging.go
[kompoxops-cmd]: ../../cmd/kompoxops
[logging-pkg]: ../../internal/logging
[naming]: ../../internal/naming
