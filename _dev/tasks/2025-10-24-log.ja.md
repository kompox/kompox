---
id: 2025-10-24-log
title: kompoxops ログ標準化（runId ヘッダ/フッタ + cmd/resourceId + ctx 付帯）
status: active
updated: 2025-10-24
language: ja
owner:
---
# Task: kompoxops ログ標準化（runId ヘッダ/フッタ + cmd/resourceId + ctx 付帯）

## 目的

- kompoxops の CLI ログ出力を標準化し、最初の 1 行に必ず次を出す：
  - `runId=<compactId> cmd=<kind>.<op> resourceId=<resourceId>`
- 最後の 1 行に必ず次を出す：
  - `runId=<compactId> cmd=<kind>.<op> resourceId=<resourceId> exitCode=<exitCode> elapsed=<elapsed>`
- `<compactId>` は `naming.NewCompactID()` の戻り値（実行単位で固定）。
- `<exitCode>` はプロセスの終了コード（0: 成功、非 0: 失敗）。
- `<elapsed>` は「最初のログ出力」からの経過秒数（小数可）。
- 以降のログには同じコンテキスト属性（runId, cmd, resourceId）が自動付帯されるように `context.Context` を活用する。
- まずは以下の代表的な 6 コマンドに適用する：
  - `kompoxops cluster provision`
  - `kompoxops cluster install`
  - `kompoxops app deploy`
  - `kompoxops app destroy`
  - `kompoxops cluster uninstall`
  - `kompoxops cluster deprovision`

## スコープ / 非スコープ

- In:
  - 上記 6 コマンドの実行開始直後にヘッダ行（`runId=<compactId> cmd=<kind>.<op> resourceId=<resourceId>`）を必ず出力。
  - プロセス終了直前（成功/失敗に関わらず）にフッタ行（`... exitCode=<exitCode> elapsed=<elapsed>`）を必ず出力。
  - ロガーに `runId`, `cmd`, `resourceId` を属性として付与したコンテキストを下位層（UseCase など）へ伝搬。
  - human/json のフォーマッタを問わず、1 行目ヘッダと最終行フッタが視認できること。
- Out:
  - 6 コマンド以外の CLI 全面適用（別タスクで段階的に対応）。
  - ログ基盤/依存パッケージの入れ替えや大規模改修。
  - ドメイン層 API 仕様の変更。

## 仕様サマリ

- 標準ヘッダ（1 行目; 実行開始時に必ず出力）:
  - 形式: `runId=<compactId> cmd=<kind>.<op> resourceId=<resourceId>`
  - 例: `runId=k4x9p7 cmd=cluster.provision resourceId=ws:foo/prv:bar/cls:baz`
  - `runId` は `naming.NewCompactID()` の戻り値で、プロセス実行単位で一意・固定。
  - `resourceId` は引数/フラグ解決後に確定させる。
- 標準フッタ（最終行; 成功/失敗を問わず必ず出力）:
  - 形式: `runId=<compactId> cmd=<kind>.<op> resourceId=<resourceId> exitCode=<exitCode> elapsed=<elapsed>`
  - `exitCode`: 0=成功、非 0=失敗。
  - `elapsed`: 最初のヘッダ出力時刻からの経過秒数（小数可）。
- ctx 付帯:
  - `logger.With("runId", <compactId>, "cmd", <kind>.<op>, "resourceId", <resourceId>)` をコンテキストに注入。
  - 以降の `logging.FromContext(ctx)` を通じて出るログに `runId`, `cmd`, `resourceId` が自動付帯。
  - 開始時刻（`startAt` など）はコンテキストに保持し、フッタ出力時に `elapsed` を計算。
- 実装ユーティリティ（案）:
  - `withRunLogHeader(ctx, kind, op, resourceId) (context.Context, cleanup func(exitCode int))`
    - ヘッダ行を Info で出力。
    - `runId`, `cmd`, `resourceId`, `startAt` を付与したロガー入りの `ctx` を返す。
    - `cleanup` を `defer` で呼ぶとフッタ行を出力（`elapsed` 計算を内包）。

## 計画 (チェックリスト)

- [ ] CLI 共通ヘルパ `withRunLogHeader` を追加（`cmd/kompoxops` もしくは共有ユーティリティに配置）。
- [ ] `cluster provision` で ResourceID 確定直後にヘッダ出力し、`defer cleanup(exitCode)` でフッタ出力。
- [ ] `cluster install` で同上。
- [ ] `app deploy` で同上。
- [ ] `app destroy` で同上。
- [ ] `cluster uninstall` で同上。
- [ ] `cluster deprovision` で同上。
- [ ] human/json ログ両方で 1 行目ヘッダと最終行フッタを確認。
- [ ] 受け入れ条件を満たすスモークテストを実行。
- [ ] タスクインデックスを更新（`make gen-index`）。

## 受け入れ条件

- 上記 6 コマンドを実行した際、標準出力の最初の 1 行が必ず `runId=<compactId> cmd=<kind>.<op> resourceId=<resourceId>` で始まる。
- 標準出力の最後の 1 行が必ず `runId=<compactId> cmd=<kind>.<op> resourceId=<resourceId> exitCode=<exitCode> elapsed=<elapsed>` で終わる。
- 以降のログ行（UseCase 層含む）に `runId`, `cmd`, `resourceId` 属性が付与される（json ではフィールド、human ではキー=値）。
- `runId` は最初と最後で同一。
- `elapsed` は最初のヘッダ出力からの経過秒数を表す（実測で正の値）。
- 従来の出力が壊れない（余分な重複出力や重大な性能劣化がない）。
- 失敗時でもヘッダとフッタは出力される。

## サンプル

- cluster/provision（human フォーマット例）

```
runId=k4x9p7 cmd=cluster.provision resourceId=ws:foo/prv:bar/cls:baz
... level=info msg="start provisioning" runId=k4x9p7 cmd=cluster.provision resourceId=ws:foo/prv:bar/cls:baz ...
... level=info msg="created resource group" runId=k4x9p7 cmd=cluster.provision resourceId=ws:foo/prv:bar/cls:baz ...
runId=k4x9p7 cmd=cluster.provision resourceId=ws:foo/prv:bar/cls:baz exitCode=0 elapsed=12.37
```

- app/deploy（json フォーマット例）

```json
{"level":"info","msg":"runId=k4x9p7 cmd=app.deploy resourceId=ws:foo/prv:bar/cls:baz/app:myapp"}
{"level":"info","msg":"apply manifests","runId":"k4x9p7","cmd":"app.deploy","resourceId":"ws:foo/prv:bar/cls:baz/app:myapp"}
{"level":"info","msg":"run finished","runId":"k4x9p7","cmd":"app.deploy","resourceId":"ws:foo/prv:bar/cls:baz/app:myapp","exitCode":0,"elapsed":8.02}
```

## メモ

- `runId` は `naming.NewCompactID()` を使用する（短く、ログやトレースの相関キーとして扱う）。
- 1 行目のヘッダは可観測性・集計軸の明示目的。以降の属性付帯は相関性の維持目的。
- フッタ行で `exitCode` と `elapsed` を必ず出すため、`RunE` の入口でヘッダと開始時刻を設定し、`defer` で終了時にフッタを出力する実装を推奨。
- 予期せぬ `panic` でもフッタを出すには、上位で `recover` を入れて exitCode を非 0 で出力するラッパーを検討。
- `resourceId` の表記は既存のリソース ID 文字列をそのまま使用する。

## 進捗

- 2025-10-24: タスク作成

## 参考

- [kompoxops-cmd]
- [logging-pkg]
- [Makefile]
 - [naming]

[kompoxops-cmd]: ../../cmd/kompoxops
[logging-pkg]: ../../internal/logging
[Makefile]: ../../Makefile
[naming]: ../../internal/naming
